<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="
  default-src 'self' 'unsafe-inline' 'unsafe-eval'
    https://cdnjs.cloudflare.com
    https://cdn.jsdelivr.net
    https://opensheet.elk.sh
    https://sweetalert2.github.io;

  connect-src 'self'
    https://script.google.com
    https://script.googleusercontent.com
    https://opensheet.elk.sh
    https://cdn.jsdelivr.net;

  script-src 'self' 'unsafe-inline' 'unsafe-eval'
    https://cdn.jsdelivr.net
    https://cdnjs.cloudflare.com
    https://sweetalert2.github.io;

  style-src 'self' 'unsafe-inline'
    https://cdnjs.cloudflare.com
    https://cdn.jsdelivr.net;

  img-src 'self' data: https:;
  font-src 'self' https://cdnjs.cloudflare.com;
">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <title>รายงานพนักงาน</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg-color: #f0f4f8;
      --card-bg: #fff;
      --text-primary: #333;
      --text-secondary: #666;
      --border-color: #ccc;
      --header-bg: #007bff;
      --header-text: #fff;
      --hover-bg: #f1f1f1;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --button-bg: linear-gradient(135deg,#3498db,#2980b9);
      --button-hover: linear-gradient(135deg,#2980b9,#1c6ea4);
      --shadow-color: rgba(0,0,0,.1);
      --modal-bg: rgba(0,0,0,.5);
      --call-count-bg: #e6f2ff;
      --modern-label-bg: #fff;
      --modern-label-border: #d0eaff;
    }
    .dark-theme {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #333;
      --header-bg: #37474f;
      --header-text: #e0e0e0;
      --hover-bg: #2a2a2a;
      --success-color: #66bb6a;
      --danger-color: #ef5350;
      --warning-color: #ffca28;
      --info-color: #42a5f5;
      --button-bg: linear-gradient(135deg,#455a64,#546e7a);
      --button-hover: linear-gradient(135deg,#546e7a,#455a64);
      --shadow-color: rgba(0,0,0,.3);
      --modal-bg: rgba(0,0,0,.7);
      --call-count-bg: #263238;
      --modern-label-bg: #2d2d2d;
      --modern-label-border: #455a64;
      .yellow-light {
        background: #2e7d32 !important;
        color: #fff !important;
      }
      .pink-pastel {
        background: #7b1fa2 !important;
        color: #fff !important;
      }
    }
    body {
      font-family: 'Prompt', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    /* Login Modal Styles */
    #loginModal {
      display: flex;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: var(--modal-bg);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    #loginModal.hidden {
      display: none;
    }
    .login-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 16px var(--shadow-color);
      position: relative;
      color: var(--text-primary);
    }
    .login-content h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--header-bg);
    }
    .login-group {
      margin-bottom: 15px;
      position: relative;
    }
    .login-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--text-primary);
    }
    .login-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .login-group input:focus {
      border-color: var(--info-color);
      outline: none;
    }
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 45px;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .remember-me {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .remember-me input[type="checkbox"] {
      width: auto;
    }
    #errorMessage {
      color: var(--danger-color);
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }
    .login-button {
      width: 100%;
      padding: 12px;
      background: var(--button-bg);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .login-button:hover {
      background: var(--button-hover);
    }
    .dark-theme .login-content {
      background: var(--card-bg);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading.show {
      display: flex;
    }
    .spinner {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--info-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .report-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      text-align: center;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 8px var(--shadow-color);
      margin-bottom: 20px;
      transition: all .3s ease;
    }
    @media (max-width: 768px){
      .report-title{
        font-size:20px;
        padding:10px;
      }
    }
    #searchContainer{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      margin-bottom:20px;
    }
    .filter-row{
      display:flex;
      align-items:center;
      margin-bottom:10px;
    }
    .search-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    #employeeFilterLabel,#pendingFilterLabel,#stockFilterLabel,#statusCallFilterLabel{
      font-size:16px;
      color: var(--text-primary);
    }
    #employeeFilter,#pendingFilter,#stockFilter,#statusCallFilter{
      margin-left:5px;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border-color);
      font-size:16px;
      background: var(--card-bg);
      color: var(--text-primary);
      cursor:pointer;
      transition:all .3s ease;
    }
    #employeeFilter:hover,#pendingFilter:hover,#stockFilter:hover,#statusCallFilter:hover{
      border-color: var(--info-color);
    }
    #searchInput{
      width:300px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border-color);
      font-size:16px;
      background: var(--card-bg);
      color: var(--text-primary);
      transition:all .3s ease;
    }
    #searchInput:focus{
      border-color: var(--info-color);
      box-shadow:0 0 8px rgba(23,162,184,.3);
      outline:none;
    }
    .action-button{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      background: var(--button-bg);
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all .3s ease;
      box-shadow:0 4px 8px var(--shadow-color);
    }
    .action-button i{
      font-size:18px;
    }
    .action-button:hover{
      background: var(--button-hover);
      transform:scale(1.05);
      box-shadow:0 6px 12px var(--shadow-color);
    }
    .action-button:active{
      transform:scale(.95);
    }
    /* Logout Button Style */
    .logout-button {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }
    .logout-button:hover {
      background: linear-gradient(135deg, #c82333, #b02a37);
    }
    .table-container{
      overflow-x:auto;
      width:100%;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background: var(--card-bg);
      box-shadow:0 4px 6px var(--shadow-color);
      border-radius:12px;
      overflow:hidden;
      min-width:1000px;
      border: 1px solid var(--border-color);
    }
    th,td{
      padding:6px 8px;
      text-align:left;
      border:1px solid var(--border-color);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text-primary);
    }
    th{
      background: var(--header-bg);
      color: var(--header-text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    th.sortable{
      cursor:pointer;
    }
    th.sortable:hover{
      background: var(--info-color);
    }
    .arrow{
      font-size:12px;
      margin-left:5px;
    }
    tr:hover{
      background: var(--hover-bg);
    }
    .detail-button{
      padding:6px 10px;
      background: var(--info-color);
      color:#fff;
      border:none;
      width:100px;
      border-radius:6px;
      cursor:pointer;
      transition:all .3s ease;
    }
    .detail-button:hover{
      background: var(--warning-color);
      transform:translateY(-2px);
      box-shadow:0 4px 10px var(--shadow-color);
    }
    .modal{
      display:none;
      position:fixed;
      z-index:1000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      overflow:auto;
      background: var(--modal-bg);
    }
    .modal-content{
      background: var(--card-bg);
      margin:10% auto;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:1200px;
      animation:zoomIn .4s ease;
      overflow-x:auto;
      position:relative;
      color: var(--text-primary);
      box-shadow: 0 8px 16px var(--shadow-color);
    }
    #spareSummaryModal .modal-content{
      max-width:95%;
    }
    .graph-modal-content{
      background: var(--card-bg);
      margin:10% auto;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:800px;
      animation:zoomIn .4s ease;
      position:relative;
      color: var(--text-primary);
    }
    .close{
      color: var(--text-secondary);
      float:right;
      font-size:24px;
      font-weight:bold;
      cursor:pointer;
    }
    .close:hover{
      color: var(--text-primary);
    }
    .print-button{
      float:right;
      margin-right:10px;
      padding:10px 16px;
      background: var(--info-color);
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      transition:all .3s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:16px;
    }
    .order-button {
      float: right;
      margin-right: 10px;
      padding: 10px 16px;
      background: var(--success-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all .3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 16px;
    }
    .order-button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px var(--shadow-color);
    }
    .print-button:hover{
      background: var(--warning-color);
      transform:translateY(-2px);
      box-shadow:0 4px 10px var(--shadow-color);
    }
    #modalContent .label{
      color: var(--info-color);
      font-weight:bold;
    }
    #modalContent .value{
      color: var(--text-primary);
    }
    #graphWarning{
      color: var(--danger-color);
      font-size:14px;
      margin-top:10px;
      text-align:center;
    }
    .pagination{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-top:20px;
    }
    .pagination button,.pagination select{
      padding:8px 12px;
      background: var(--info-color);
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:16px;
      margin:0 5px;
      transition:all .3s ease;
    }
    .pagination button:hover,.pagination select:hover{
      background: var(--warning-color);
    }
    .pagination .page-number{
      width:36px;
      height:36px;
      background: var(--info-color);
      color:#fff;
      border-radius:50%;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      margin:0 5px;
      cursor:pointer;
      font-size:16px;
      border:none;
      transition:all .3s ease;
    }
    .pagination .page-number:hover{
      background: var(--warning-color);
      transform:scale(1.1);
    }
    .pagination .page-number.active{
      background: var(--warning-color);
      color:#fff;
    }
    .items-per-page{
      margin-left:10px;
      font-size:16px;
      color: var(--text-primary);
    }
    tr{
      opacity:0;
      transform:translateY(10px);
      animation:fadeInUp .5s ease forwards;
    }
    tr:nth-child(even){
      animation-delay:.1s;
    }
    tr:nth-child(odd){
      animation-delay:.2s;
    }
    @keyframes fadeInUp{
      to{
        opacity:1;
        transform:translateY(0);
      }
    }
    @keyframes zoomIn{
      from{
        opacity:0;
        transform:scale(.8);
      }
      to{
        opacity:1;
        transform:scale(1);
      }
    }
    th:nth-child(1), td:nth-child(1) { min-width: 60px; max-width: 60px; } /* DayRepair */
    th:nth-child(2), td:nth-child(2) { min-width: 100px; max-width: 120px; } /* DateTime */
    th:nth-child(3), td:nth-child(3) { min-width: 120px; max-width: 140px; } /* Ticket Number */
    th:nth-child(4), td:nth-child(4) { min-width: 150px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Brand */
    th:nth-child(5), td:nth-child(5) { min-width: 70px; max-width: 80px; } /* Call Type */
    th:nth-child(6), td:nth-child(6) { min-width: 80px; max-width: 100px; } /* Team */
    th:nth-child(7), td:nth-child(7) { min-width: 100px; max-width: 120px; } /* TeamPlant */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; max-width: 140px; } /* ค้างหน่วยงาน */
    th:nth-child(9), td:nth-child(9) { min-width: 80px; max-width: 100px; } /* Material */
    th:nth-child(10), td:nth-child(10) { min-width: 200px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Description */
    th:nth-child(11), td:nth-child(11) { min-width: 50px; max-width: 50px; text-align: center; } /* Nawa */
    th:nth-child(12), td:nth-child(12) { min-width: 50px; max-width: 50px; text-align: center; } /* Vipa */
    th:nth-child(13), td:nth-child(13) { min-width: 50px; max-width: 50px; text-align: center; } /* Request */
    th:nth-child(14), td:nth-child(14) { min-width: 50px; max-width: 50px; text-align: center; } /* QtyPlant */
    th:nth-child(15), td:nth-child(15) { min-width: 150px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* คลังตอบ */
    th:nth-child(16), td:nth-child(16) { min-width: 80px; max-width: 100px; } /* StatusCall */
    th:nth-child(17), td:nth-child(17) { min-width: 100px; max-width: 120px; } /* วันที่ตอบ */
    th:nth-child(18), td:nth-child(18) { min-width: 80px; max-width: 100px; } /* UserAns */
    th:nth-child(19), td:nth-child(19) { min-width: 150px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Answer1 */
    th:nth-child(20), td:nth-child(20) { min-width: 100px; max-width: 120px; text-align: center; } /* Detail Button */
    @media (max-width: 768px){
      th, td { padding: 4px 4px; font-size: 12px; }
      th:nth-child(1), td:nth-child(1) { min-width: 50px; max-width: 50px; }
      th:nth-child(2), td:nth-child(2) { min-width: 80px; max-width: 100px; }
      th:nth-child(3), td:nth-child(3) { min-width: 100px; max-width: 120px; }
      th:nth-child(4), td:nth-child(4) { min-width: 100px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Brand */
      th:nth-child(5), td:nth-child(5) { min-width: 60px; max-width: 70px; }
      th:nth-child(6), td:nth-child(6) { min-width: 70px; max-width: 80px; }
      th:nth-child(7), td:nth-child(7) { min-width: 80px; max-width: 100px; }
      th:nth-child(8), td:nth-child(8) { min-width: 100px; max-width: 120px; }
      th:nth-child(9), td:nth-child(9) { min-width: 70px; max-width: 80px; }
      th:nth-child(10), td:nth-child(10) { min-width: 150px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Description */
      th:nth-child(11), td:nth-child(11) { min-width: 40px; max-width: 40px; }
      th:nth-child(12), td:nth-child(12) { min-width: 40px; max-width: 40px; }
      th:nth-child(13), td:nth-child(13) { min-width: 40px; max-width: 40px; }
      th:nth-child(14), td:nth-child(14) { min-width: 40px; max-width: 40px; }
      th:nth-child(15), td:nth-child(15) { min-width: 100px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* คลังตอบ */
      th:nth-child(16), td:nth-child(16) { min-width: 70px; max-width: 80px; }
      th:nth-child(17), td:nth-child(17) { min-width: 80px; max-width: 100px; }
      th:nth-child(18), td:nth-child(18) { min-width: 70px; max-width: 80px; }
      th:nth-child(19), td:nth-child(19) { min-width: 100px; max-width: none; white-space: nowrap; overflow: visible; text-overflow: clip; } /* Answer1 */
      th:nth-child(20), td:nth-child(20) { min-width: 80px; max-width: 90px; }
      #searchInput{
        width:100%;
        max-width:300px;
      }
      .search-row{
        flex-direction:column;
        align-items:flex-start;
      }
      .action-button{
        width:100%;
        max-width:150px;
        justify-content:center;
      }
    }
    .yellow-light{
      background:#c9ffc4;
    }
    .pink-pastel{
      background:#fce4ec;
    }
    .text-left{
      text-align:left;
    }
    .text-center{
      text-align:center;
    }
    .call-count-box{
      margin-left:20px;
      padding:10px 16px;
      background: var(--call-count-bg);
      color: var(--info-color);
      border-radius:10px;
      font-size:16px;
      font-weight:bold;
      display:inline-flex;
      align-items:center;
      box-shadow:0 2px 4px var(--shadow-color);
      transition:background .3s ease;
    }
    .call-count-box span{
      color: var(--danger-color);
      margin:0 4px;
      font-size:18px;
    }
    .modern-label{
      display:inline-block;
      padding:10px 16px;
      background: var(--modern-label-bg);
      color: var(--info-color);
      border-radius:10px;
      font-size:16px;
      font-weight:bold;
      box-shadow:0 2px 6px var(--shadow-color);
      border:1px solid var(--modern-label-border);
      transition:all .3s ease;
      margin-right:8px;
    }
    .modern-label:hover{
      background: var(--hover-bg);
      color: var(--warning-color);
    }
    .detail-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      border: 1px solid var(--border-color);
    }
    .detail-table th,.detail-table td{
      padding:8px;
      border:1px solid var(--border-color);
      text-align:center;
      color: var(--text-primary);
    }
    .detail-table th{
      background: var(--header-bg);
      color: var(--header-text);
    }
    .detail-table tr:nth-child(even){
      background: var(--hover-bg);
    }
    /* ความกว้างคอลัมน์ตัวอย่าง */
    .detail-table th:not(:first-child),.detail-table td:not(:first-child){
      width:80px;
      min-width:80px;
      max-width:80px;
    }
    .detail-table th:first-child,.detail-table td:first-child{
      width:auto;
      min-width:120px;
    }
    /* คอลัมน์ 2 ในตารางทั่วไปเดิมเป็นชิดซ้าย */
    .detail-table th:nth-child(2), .detail-table td:nth-child(2) {
      width: 50%;
      min-width: 250px;
      max-width: none;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      text-align: left;
    }
    /* ✅ Center เฉพาะคอลัมน์ "รวม" ในตารางสรุป */
    .summary-table th:nth-child(2), .summary-table td:nth-child(2){
      text-align:center !important;
    }
    @media print{
      .report-title,.close,.print-button,.order-button,#printTableButton,#searchButton,#excelButton,#summaryButton,#spareSummaryButton,#searchInput,.pagination,#searchContainer,.modal,.table-container,.loading{
        display:none;
      }
      .modal-content{
        margin:0;
        padding:0;
        width:100%;
        max-width:none;
        border-radius:0;
        box-shadow:none;
      }
      .sticker{
        width:80mm;
        height:100mm;
        border:1px solid #000;
        padding:2mm;
        box-sizing:border-box;
        font-size:13pt;
        line-height:1.3;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        justify-content:space-between;
        page-break-after:always;
      }
      .sticker div{
        margin-bottom:1.5mm;
        overflow-wrap:break-word;
      }
      .sticker div.description{
        flex:1;
      }
      .sticker .label{
        font-weight:bold;
        color:#000;
        font-size:14pt;
      }
      .sticker .value{
        color:#000;
      }
      h2{
        font-size:14pt;
        color:#000;
        margin:1.5mm 0;
      }
      @page{
        size:80mm 100mm;
        margin:0;
      }
      body{
        margin:0;
        padding:0;
      }
      .detail-table th,.detail-table td{
        text-align:center;
      }
      .detail-table th:not(:first-child),.detail-table td:not(:first-child){
        width:80px;
        min-width:80px;
        max-width:80px;
      }
      .detail-table th:first-child,.detail-table td:first-child{
        width:auto;
        min-width:120px;
      }
      .detail-table td:nth-child(2),
      .detail-table th:nth-child(2) {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: none;
      }
    }
    .green-text{
      color: var(--success-color);
    }
    .red-text{
      color: var(--danger-color);
    }
    .timeline-table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      border: 1px solid var(--border-color);
    }
    .timeline-table th,.timeline-table td{
      padding:8px;
      border:1px solid var(--border-color);
      text-align:left;
      white-space:pre-wrap;
      word-wrap:break-word;
      color: var(--text-primary);
    }
    .timeline-table th{
      background: var(--header-bg);
      color: var(--header-text);
    }
    .timeline-table tr:nth-child(even){
      background: var(--hover-bg);
    }
    .detail-table th:nth-child(1),.detail-table td:nth-child(1){
      width:20%;
      min-width:50px;
      max-width:80px;
      white-space:normal;
    }
    .detail-table th:nth-child(2),.detail-table td:nth-child(2){
      width:40%;
      min-width:200px;
      max-width:350px;
      white-space:normal;
      text-align:left;
    }
    .detail-table th:nth-child(3),.detail-table td:nth-child(3){
      width:10%;
      min-width:80px;
      max-width:100px;
      text-align:center;
    }
    .detail-table th:nth-child(n+4),.detail-table td:nth-child(n+4){
      width:10%;
      min-width:80px;
      max-width:100px;
      text-align:center;
    }
    th:nth-child(12),td:nth-child(12){
      font-weight:bold;
      color: var(--danger-color);
    }
    th:nth-child(13),td:nth-child(13){
      font-weight:bold;
      color: var(--text-primary);
    }
    .date-update{
      text-align:center;
      background: var(--card-bg);
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 4px var(--shadow-color);
      margin-bottom:10px;
      font-size:16px;
      color: var(--text-primary);
      font-weight:500;
    }
    .date-update span{
      color: var(--info-color);
      font-weight:bold;
    }
    .setting-modal-content {
      max-width: 400px;
    }
    .theme-option {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: var(--hover-bg);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .theme-option:hover {
      background: var(--info-color);
      color: #fff;
    }
    .theme-option input[type="radio"] {
      margin-right: 10px;
    }
    /* Dashboard Styles */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px var(--shadow-color);
      text-align: center;
      transition: transform 0.3s ease;
      color: white;
      cursor: pointer;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    .dashboard-card.active {
      border: 3px solid #fff;
      box-shadow: 0 8px 16px rgba(255,255,255,0.3);
    }
    .dashboard-card h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }
    .dashboard-card .value {
      font-size: 2.5em;
      font-weight: bold;
    }
    .total-card {
      background: linear-gradient(135deg, #007bff, #0056b3);
    }
    .pending-card {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }
    .success-card {
      background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    .new-card {
      background: linear-gradient(135deg, #ffc107, #e0a800);
    }
    .over7-card {
      background: linear-gradient(135deg, #fd7e14, #f06c00);
    }
    .request-card {
      background: linear-gradient(135deg, #20c997, #0d9488);
    }
    .nawa-card {
      background: linear-gradient(135deg, #6f42c1, #5a2d91);
    }
    .max-card {
      background: linear-gradient(135deg, #6c757d, #545b62);
    }
    .graph-card {
      background: linear-gradient(135deg, #6f42c1, #5a2d91);
    }
    .spare-card {
      background: linear-gradient(135deg, #28a745, #20c09d);
    }
    .calltype-p-card {
      background: linear-gradient(135deg, #4caf50, #2e7d32);
    }
    .calltype-c-card {
      background: linear-gradient(135deg, #f44336, #d32f2f);
    }
    .calltype-b-card {
      background: linear-gradient(135deg, #2196f3, #1976d2);
    }
    .calltype-u-card {
      background: linear-gradient(135deg, #ffeb3b, #fbc02d);
    }
    .calltype-other-card {
      background: linear-gradient(135deg, #9e9e9e, #757575);
    }
    .dark-theme .total-card {
      background: linear-gradient(135deg, #42a5f5, #1976d2);
    }
    .dark-theme .pending-card {
      background: linear-gradient(135deg, #ef5350, #d32f2f);
    }
    .dark-theme .success-card {
      background: linear-gradient(135deg, #66bb6a, #388e3c);
    }
    .dark-theme .new-card {
      background: linear-gradient(135deg, #ffca28, #ffb300);
    }
    .dark-theme .over7-card {
      background: linear-gradient(135deg, #ff9800, #f57c00);
    }
    .dark-theme .request-card {
      background: linear-gradient(135deg, #26a69a, #00796b);
    }
    .dark-theme .nawa-card {
      background: linear-gradient(135deg, #ab47bc, #8e24aa);
    }
    .dark-theme .max-card {
      background: linear-gradient(135deg, #90a4ae, #78909c);
    }
    .dark-theme .graph-card {
      background: linear-gradient(135deg, #ab47bc, #8e24aa);
    }
    .dark-theme .spare-card {
      background: linear-gradient(135deg, #66bb6a, #4caf50);
    }
    .dark-theme .calltype-p-card {
      background: linear-gradient(135deg, #81c784, #66bb6a);
    }
    .dark-theme .calltype-c-card {
      background: linear-gradient(135deg, #e57373, #ef5350);
    }
    .dark-theme .calltype-b-card {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
    }
    .dark-theme .calltype-u-card {
      background: linear-gradient(135deg, #fff176, #ffca28);
    }
    .dark-theme .calltype-other-card {
      background: linear-gradient(135deg, #b0bec5, #90a4ae);
    }
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      .dashboard-card .value {
        font-size: 2em;
      }
    }
    /* Call Type Dashboard Specific Styles (ปรับขนาดใหญ่ขึ้น 125% เพื่อความชัดเจน, ใช้ minmax(100px,1fr)) */
    #callTypeDashboard {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* เพิ่มจาก 60px เป็น 100px */
      gap: 8px; /* เพิ่มจาก 5px เป็น 8px */
      margin-bottom: 8px; /* เพิ่มจาก 5px เป็น 8px */
    }
    #callTypeDashboard .dashboard-card {
      padding: 8px; /* เพิ่มจาก 5px เป็น 8px */
    }
    #callTypeDashboard .dashboard-card h3 {
      font-size: 1em; /* เพิ่มจาก 0.8em เป็น 1em */
      margin-bottom: 4px; /* เพิ่มจาก 2px เป็น 4px */
    }
    #callTypeDashboard .dashboard-card .value {
      font-size: 1.2em; /* เพิ่มจาก 0.8em เป็น 1.2em */
      font-weight: bold;
    }
    /* Active State: เปลี่ยนเฉพาะสีพื้นหลังแบบนุ่มนวล ไม่ขยายขนาด */
    #callTypeDashboard .dashboard-card.active {
      transform: none; /* ไม่ขยายขนาด */
      border: none; /* ลบขอบขาว */
      box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2); /* เงาเบาๆ */
      transition: background 0.3s ease; /* เปลี่ยนสีลื่นไหล */
    }
    /* สี Active สำหรับแต่ละ Call Type (ปรับให้สว่าง/เด่นขึ้น) */
    #callTypeDashboard .calltype-p-card.active {
      background: linear-gradient(135deg, #66bb6a, #4caf50); /* เขียวสว่างสำหรับ P */
    }
    #callTypeDashboard .calltype-c-card.active {
      background: linear-gradient(135deg, #ef5350, #e53935); /* แดงสดสำหรับ C */
    }
    #callTypeDashboard .calltype-b-card.active {
      background: linear-gradient(135deg, #42a5f5, #1e88e5); /* น้ำเงินเข้มสว่างสำหรับ B */
    }
    #callTypeDashboard .calltype-u-card.active {
      background: linear-gradient(135deg, #ffca28, #ffc107); /* ส้มเหลืองสดสำหรับ U */
    }
    #callTypeDashboard .calltype-other-card.active {
      background: linear-gradient(135deg, #90a4ae, #78909c); /* เทาเข้มสว่างสำหรับอื่นๆ */
    }
    .dark-theme #callTypeDashboard .calltype-p-card.active {
      background: linear-gradient(135deg, #81c784, #66bb6a); /* ปรับสำหรับ dark mode */
    }
    .dark-theme #callTypeDashboard .calltype-c-card.active {
      background: linear-gradient(135deg, #e57373, #ef5350); /* ปรับสำหรับ dark mode */
    }
    .dark-theme #callTypeDashboard .calltype-b-card.active {
      background: linear-gradient(135deg, #64b5f6, #42a5f5); /* ปรับสำหรับ dark mode */
    }
    .dark-theme #callTypeDashboard .calltype-u-card.active {
      background: linear-gradient(135deg, #fff176, #ffca28); /* ปรับสำหรับ dark mode */
    }
    .dark-theme #callTypeDashboard .calltype-other-card.active {
      background: linear-gradient(135deg, #b0bec5, #90a4ae); /* ปรับสำหรับ dark mode */
    }
    /* Hover: ยังคง translateY เบาๆ เพื่อ feedback แต่ไม่ขยาย */
    #callTypeDashboard .dashboard-card:hover {
      transform: translateY(-2px);
    }
    /* ลบ Pulse animation ออก */
    @media (max-width: 768px) {
      #callTypeDashboard {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* เพิ่มจาก 50px เป็น 80px ใน mobile */
        gap: 6px; /* เพิ่มจาก 3px เป็น 6px */
      }
      #callTypeDashboard .dashboard-card {
        padding: 6px; /* เพิ่มจาก 3px เป็น 6px */
      }
      #callTypeDashboard .dashboard-card h3 {
        font-size: 0.9em; /* เพิ่มจาก 0.7em เป็น 0.9em */
      }
      #callTypeDashboard .dashboard-card .value {
        font-size: 1em; /* เพิ่มจาก 0.7em เป็น 1em */
      }
    }
    /* ✅ ใหม่: CSS สำหรับ Container กรอบตาราง Call Type (แบบกลุ่ม) */
    .call-type-table-container {
      display: flex;
      justify-content: flex-start; /* เปลี่ยนจาก center เป็น flex-start เพื่อชิดซ้าย */
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 8px var(--shadow-color);
      padding: 15px;
      border: 2px solid var(--border-color);
      overflow: hidden;
      position: relative; /* สำหรับ absolute positioning ของ ::before */
    }
    .call-type-table-container::before {
      position: absolute;
      top: -10px;
      left: 20px;
      background: var(--header-bg);
      color: var(--header-text);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1;
    }
    .dark-theme .call-type-table-container {
      border-color: var(--border-color);
      background: var(--card-bg);
    }
    /* ปรับ #callTypeDashboard ให้อยู่ใน container และดูเป็นตารางมากขึ้น */
    #callTypeDashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* คง 4 คอลัมน์เพื่อให้เป็นตารางสี่เหลี่ยม */
      gap: 8px; /* เพิ่ม gap เล็กน้อย */
      width: 100%;
      max-width: 500px; /* เพิ่มจาก 400px เป็น 500px เพื่อความกว้างมากขึ้น */
      margin: 0; /* ลบ margin: 0 auto; เพื่อชิดซ้าย */
    }
    #callTypeDashboard .dashboard-card {
      border: 1px solid rgba(255, 255, 255, 0.2); /* เพิ่มกรอบบางรอบแต่ละการ์ด */
      border-radius: 6px;
      padding: 8px; /* เพิ่ม padding เล็กน้อย */
      transition: all 0.3s ease;
    }
    #callTypeDashboard .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    @media (max-width: 768px) {
      .call-type-table-container {
        padding: 10px;
        margin-bottom: 15px;
        justify-content: flex-start; /* ชิดซ้ายใน mobile ด้วย */
      }
      #callTypeDashboard {
        grid-template-columns: repeat(2, 1fr); /* ใน mobile: 2 คอลัมน์เพื่อ responsive */
        max-width: 100%; /* ใช้เต็มความกว้าง container */
        gap: 6px;
        margin: 0; /* คงชิดซ้าย */
      }
      #callTypeDashboard .dashboard-card {
        padding: 6px;
        border-width: 1px;
      }
      .call-type-table-container::before {
        left: 10px;
        font-size: 12px;
        padding: 3px 10px;
      }
    }
    /* ถ้ามีมากกว่า 4 Call Type จะ wrap แต่คง layout ตาราง */
    #callTypeDashboard:has(.dashboard-card:nth-child(5)) {
      grid-template-columns: repeat(5, 1fr);
    }
    /* ✅ เพิ่ม CSS สำหรับตารางสรุปอะไหล่ (กะทัดรัดและ Responsive) */
    .detail-table td:nth-child(2),
    .detail-table th:nth-child(2) {
      /* กะทัดรัด: ใช้ ellipsis สำหรับ desktop */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
      min-width: 150px;
      width: 25%; /* ลดสัดส่วน */
      text-align: left;
    }
    /* Responsive สำหรับหน้าจอเล็ก */
    @media (max-width: 768px) {
      .detail-table {
        font-size: 12px; /* ลดขนาดฟอนต์ */
      }
      .detail-table th,
      .detail-table td {
        padding: 4px 6px; /* ลด padding */
      }
      .detail-table td:nth-child(2),
      .detail-table th:nth-child(2) {
        /* ใน mobile: อนุญาต wrap เพื่อให้อ่านง่าย */
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: none;
        min-width: 120px;
        width: 35%; /* เพิ่มสัดส่วนใน mobile */
      }
      .detail-table th:not(:first-child),
      .detail-table td:not(:first-child) {
        /* ลดความกว้างคอลัมน์ตัวเลขใน mobile */
        min-width: 60px;
        max-width: 60px;
        width: 8%;
      }
      .detail-table th:first-child,
      .detail-table td:first-child {
        min-width: 80px; /* ลด min-width สำหรับ Material */
      }
      /* ทำให้ modal-content scroll ได้ดีขึ้นใน mobile */
      #spareSummaryModal .modal-content {
        width: 98%;
        margin: 5% auto;
        padding: 10px;
      }
    }
    /* ✅ เพิ่ม CSS เฉพาะสำหรับตารางสรุปอะไหล่ เพื่อให้กะทัดรัดมากขึ้นและลดขนาดตัวอักษร */
    #spareSummaryModal .detail-table {
      font-size: 12px; /* เพิ่มขนาดฟอนต์จาก 10px เป็น 12px */
    }
    #spareSummaryModal .detail-table th,
    #spareSummaryModal .detail-table td {
      padding: 4px 6px; /* เพิ่ม padding เล็กน้อยจาก 2px 3px เพื่อความสบายตา */
      border: 0.5px solid var(--border-color); /* เส้นบางลง */
    }
    #spareSummaryModal .detail-table td:nth-child(2),
    #spareSummaryModal .detail-table th:nth-child(2) {
      /* กะทัดรัดมากขึ้น */
      max-width: none;
      min-width: 250px;
      width: 50%; /* เพิ่มสัดส่วน */
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      text-align: left;
    }
    #spareSummaryModal .detail-table th:not(:first-child),
    #spareSummaryModal .detail-table td:not(:first-child) {
      min-width: 40px;
      max-width: 50px;
      width: 7%;
    }
    #spareSummaryModal .detail-table th:first-child,
    #spareSummaryModal .detail-table td:first-child {
      min-width: 60px; /* ลด min-width สำหรับ Material */
    }
    @media (max-width: 768px) {
      #spareSummaryModal .detail-table {
        font-size: 11px; /* เพิ่มจาก 9px เป็น 11px ใน mobile */
      }
      #spareSummaryModal .detail-table th,
      #spareSummaryModal .detail-table td {
        padding: 2px 4px; /* ปรับ padding ใน mobile */
      }
      #spareSummaryModal .detail-table td:nth-child(2),
      #spareSummaryModal .detail-table th:nth-child(2) {
        min-width: 180px;
        width: 55%;
      }
    }
    /* ✅ เพิ่ม CSS สำหรับตารางสรุปอะไหล่: เพิ่มความกว้าง Description และลด Material */
    #spareSummaryModal .detail-table th:nth-child(1),
    #spareSummaryModal .detail-table td:nth-child(1) {
      /* ลดขนาด Material */
      width: 8%;
      min-width: 40px;
      max-width: 50px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #spareSummaryModal .detail-table th:nth-child(2),
    #spareSummaryModal .detail-table td:nth-child(2) {
      /* เพิ่มความกว้าง Description เพื่อเห็นข้อมูลทั้งหมด */
      width: 50%; /* เพิ่มสัดส่วนจาก 35% เป็น 50% */
      min-width: 250px; /* เพิ่ม min-width จาก 150px เป็น 250px */
      max-width: none; /* อนุญาตให้กว้างขึ้น */
      white-space: nowrap; /* เปลี่ยนเป็น nowrap เพื่ออยู่ในบรรทัดเดียว */
      overflow: visible;
      text-overflow: clip;
      text-align: left;
      /* ลบ word-wrap, word-break เพื่อไม่ให้ตัดบรรทัด */
      line-height: 1.3; /* ปรับ line-height เพื่ออ่านง่าย */
    }
    #spareSummaryModal .detail-table th:nth-child(3),
    #spareSummaryModal .detail-table td:nth-child(3) {
      /* จำนวนรวม: คงเดิมหรือปรับเล็กน้อย */
      width: 10%;
      min-width: 50px;
    }
    #spareSummaryModal .detail-table th:nth-child(n+4),
    #spareSummaryModal .detail-table td:nth-child(n+4) {
      /* คอลัมน์ pending units: ลดลงเพื่อชดเชย */
      width: 6%;
      min-width: 35px;
      max-width: 45px;
    }
    @media (max-width: 768px) {
      #spareSummaryModal .detail-table th:nth-child(1),
      #spareSummaryModal .detail-table td:nth-child(1) {
        width: 10%;
        min-width: 30px;
      }
      #spareSummaryModal .detail-table th:nth-child(2),
      #spareSummaryModal .detail-table td:nth-child(2) {
        width: 55%; /* เพิ่มใน mobile จาก 40% เป็น 55% */
        min-width: 200px; /* ปรับ min-width ใน mobile */
      }
      #spareSummaryModal .detail-table th:nth-child(n+4),
      #spareSummaryModal .detail-table td:nth-child(n+4) {
        width: 5%;
        min-width: 30px;
      }
    }
    /* สำหรับ print: รักษา ellipsis หรือ wrap ตามปกติ */
    @media print {
      .detail-table td:nth-child(2),
      .detail-table th:nth-child(2) {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: none;
      }
      #spareSummaryModal .detail-table {
        font-size: 12px; /* เพิ่มขนาดฟอนต์สำหรับ print จาก 11px เป็น 12px */
      }
      #spareSummaryModal .detail-table th,
      #spareSummaryModal .detail-table td {
        padding: 4px 6px; /* ปรับ padding สำหรับ print */
        border: 1px solid #ccc;
      }
      /* Print specific for spare summary */
      #spareSummaryModal .detail-table th:nth-child(1),
      #spareSummaryModal .detail-table td:nth-child(1) {
        width: 10%;
        min-width: 50px;
      }
      #spareSummaryModal .detail-table th:nth-child(2),
      #spareSummaryModal .detail-table td:nth-child(2) {
        width: 35%; /* เพิ่มสัดส่วนสำหรับ print */
        min-width: 120px;
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
        line-height: 1.3;
      }
    }
    /* เพิ่ม CSS สำหรับ Progress Bar สไตล์ Canva (สวยงาม, ใช้ gradient, rounded) */
    .progress-container {
      margin-top: 10px;
      background-color: rgba(255, 255, 255, 0.2); /* พื้นหลังโปร่งแสง */
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      border-radius: 20px;
      transition: width 0.5s ease-in-out;
      background: linear-gradient(90deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%); /* Gradient สไตล์ Canva */
    }
    .progress-text {
      font-size: 0.8em;
      margin-top: 5px;
      color: rgba(255, 255, 255, 0.9);
    }
    .dark-theme .progress-container {
      background-color: rgba(0, 0, 0, 0.2);
    }
    .dark-theme .progress-bar {
      background: linear-gradient(90deg, #e0e0e0 0%, rgba(224, 224, 224, 0.8) 100%);
    }
    .dark-theme .progress-text {
      color: rgba(224, 224, 224, 0.9);
    }
    /* Adjusted progress for smaller Call Type cards */
    #callTypeDashboard .progress-container {
      height: 4px; /* เพิ่มจาก 3px เป็น 4px สำหรับการ์ดขนาดใหญ่ขึ้น */
      margin-top: 3px; /* เพิ่มจาก 2px เป็น 3px */
    }
    #callTypeDashboard .progress-text {
      font-size: 0.7em; /* เพิ่มจาก 0.6em เป็น 0.7em */
      margin-top: 2px; /* เพิ่มจาก 1px เป็น 2px */
    }
    /* ✅ ปรับปรุง Container สำหรับข้อมูลสรุป (เพิ่ม padding, font-size, และ contrast เพื่อความชัดเจน) */
    .call-type-table-container {
      padding: 20px; /* เพิ่มจาก 15px เป็น 20px */
      margin-bottom: 25px; /* เพิ่มจาก 20px เป็น 25px */
    }
    .call-type-table-container::before {
      font-size: 16px; /* เพิ่มจาก 14px เป็น 16px */
      padding: 8px 20px; /* เพิ่ม padding */
      top: -12px; /* ปรับตำแหน่ง */
      left: 25px; /* ปรับตำแหน่ง */
    }
    /* เพิ่ม contrast สำหรับข้อความใน Call Type Cards */
    #callTypeDashboard .dashboard-card h3,
    #callTypeDashboard .dashboard-card .value,
    #callTypeDashboard .dashboard-card .progress-text {
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* เพิ่มเงาเพื่อความชัดเจน */
      color: #fff !important; /* บังคับสีขาวสำหรับข้อความ */
    }
    .dark-theme #callTypeDashboard .dashboard-card h3,
    .dark-theme #callTypeDashboard .dashboard-card .value,
    .dark-theme #callTypeDashboard .dashboard-card .progress-text {
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* ปรับเงาสำหรับ dark mode */
      color: #e0e0e0 !important; /* สีอ่อนสำหรับ dark mode */
    }
    /* ปรับขนาด max-width ของ container เพื่อให้กว้างขึ้นและชัดเจน */
    #callTypeDashboard {
      max-width: 600px; /* เพิ่มจาก 500px เป็น 600px */
    }
    @media (max-width: 768px) {
      .call-type-table-container::before {
        font-size: 14px; /* คงเดิมแต่เพิ่ม padding */
        padding: 5px 15px;
      }
      #callTypeDashboard {
        max-width: 100%;
        grid-template-columns: repeat(2, 1fr);
      }
    }
    /* Hide app content until logged in */
    .app-content {
      display: none;
      position: relative; /* สำหรับ positioning ของ hamburger menu */
    }
    .app-content.logged-in {
      display: block;
    }
    /* Hamburger Menu Styles */
    .hamburger-menu {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1001;
    }
    .hamburger-icon {
      font-size: 24px;
      color: var(--text-primary);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: var(--card-bg);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .hamburger-icon:hover {
      background: var(--hover-bg);
      transform: scale(1.1);
    }
    .settings-dropdown {
      position: absolute;
      top: 60px;
      left: 20px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 8px var(--shadow-color);
      padding: 15px;
      display: none;
      z-index: 1000;
      min-width: 200px;
      border: 1px solid var(--border-color);
    }
    .settings-dropdown.show {
      display: block;
    }
    .user-info-in-menu {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    .user-info-in-menu strong {
      display: block;
      margin-bottom: 5px;
    }
    .theme-button, .logout-button-in-menu {
      width: 100%;
      margin-bottom: 8px;
      justify-content: flex-start;
    }
    .dark-theme .settings-dropdown {
      background: var(--card-bg);
      border-color: var(--border-color);
    }
    /* User Info Display (removed original, now in dropdown) */
        .header-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
  margin-bottom: 20px;
}
.report-title {
  text-align: center;
  margin: 0; /* ลบ margin ด้านล่างเพื่อให้ปุ่ม align ดี */
  /* คง padding และ background ไว้ตามเดิม */
}
.setting-header-btn {
  position: absolute;
  top: 50%;
  right: 20px; /* ปรับระยะห่างจากขอบขวา */
  transform: translateY(-50%);
  margin: 0;
  padding: 8px 12px; /* ลด padding เล็กน้อยให้กะทัดรัด */
  font-size: 13px; /* ลดขนาดฟอนต์เล็กน้อย */
  box-shadow: 0 2px 4px var(--shadow-color); /* เงาเบาๆ */
  transition: all 0.3s ease;
}
.setting-header-btn:hover {
  transform: translateY(-50%) scale(1.05);
  box-shadow: 0 4px 8px var(--shadow-color);
}
/* Responsive สำหรับมือถือ */
@media (max-width: 768px) {
  .setting-header-btn {
    right: 10px;
    padding: 6px 10px;
    font-size: 12px;
  }
}
.spinner {
  border: 4px solid #ffffff50;
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 35px;
  height: 35px;
  animation: spin 0.8s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal">
    <div class="login-content">
      <h2><i class="fas fa-user-lock"></i> เข้าสู่ระบบ</h2>
      <div id="errorMessage">กรุณาใส่ข้อมูลให้ถูกต้อง</div>
      <form id="loginForm">
        <div class="login-group">
          <label for="username">รหัสพนักงาน (Username)</label>
          <input type="text" id="username" placeholder="" maxlength="7" required>
        </div>
        <div class="login-group">
          <label for="password">รหัสผ่าน (Password)</label>
          <input type="password" id="password" placeholder="" maxlength="4" required>
          <i class="fas fa-eye password-toggle" id="togglePassword" style="display: none;"></i>
        </div>
        <div class="remember-me">
          <input type="checkbox" id="rememberMe">
          <label for="rememberMe">จำฉันไว้</label>
        </div>
        <button type="submit" class="login-button"><i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ</button>
      </form>
    </div>
  </div>
  <!-- App Content (Hidden until login) -->
  <div id="appContent" class="app-content">
    <!-- Hamburger Menu -->
    <div class="hamburger-menu">
      <i class="fas fa-bars hamburger-icon" id="hamburgerIcon"></i>
    </div>
    <!-- Settings Dropdown -->
    <div id="settingsDropdown" class="settings-dropdown">
      <div id="userInfoInMenu" class="user-info-in-menu" style="display: none;">
        <strong>ยินดีต้อนรับ:</strong> <span id="displayUserNameInMenu"></span>
        <br>
        <strong>หน่วยงาน:</strong> <span id="displayUnit">-</span>
        <br>
        <strong>Plant:</strong> <span id="displayPlant">-</span>
        <button id="themeButton" class="action-button theme-button"><i class="fas fa-cog"></i> ตั้งค่า</button>
        <button id="logoutButtonInMenu" class="action-button logout-button logout-button-in-menu">
          <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
        </button>
      </div>
    </div>
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>กำลังโหลดข้อมูล...</p>
    </div>
    <h1 class="report-title">รายการอะไหล่ Call ค้างคลังสินค้า Sparepare </h1>
    <div id="dateUpdate" class="date-update">Data Update: <span id="updateValue">-</span></div>
    <!-- Dashboard Section -->
    <div id="dashboard" class="dashboard">
      <div id="totalCard" class="dashboard-card total-card">
        <h3>Call ทั้งหมด</h3>
        <div class="value" id="totalCalls">0</div>
        <div class="progress-container"><div id="totalProgress" class="progress-bar" style="width: 100%;"></div></div>
        <div class="progress-text" id="totalPercent">100%</div>
      </div>
      <div id="pendingCard" class="dashboard-card pending-card">
        <h3>Call ค้าง (รอของเข้า)</h3>
        <div class="value" id="callsPending">0</div>
        <div class="progress-container"><div id="pendingProgress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="pendingPercent">0%</div>
      </div>
      <div id="successCard" class="dashboard-card success-card">
        <h3>Call (ระหว่างขนส่ง)</h3>
        <div class="value" id="callsSuccess">0</div>
        <div class="progress-container"><div id="successProgress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="successPercent">0%</div>
      </div>
      <div id="nawaCard" class="dashboard-card nawa-card">
        <h3>Call (เบิกศูนย์อะไหล่)</h3>
        <div class="value" id="callsNawaVipa">0</div>
        <div class="progress-container"><div id="nawaProgress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="nawaPercent">0%</div>
      </div>
      <div id="requestCard" class="dashboard-card request-card">
        <h3>Call (ขอซื้อขอซ่อม)</h3>
        <div class="value" id="callsRequest">0</div>
        <div class="progress-container"><div id="requestProgress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="requestPercent">0%</div>
      </div>
      <div id="over7Card" class="dashboard-card over7-card">
        <h3>Call เกิน 7 วัน</h3>
        <div class="value" id="callsOver7">0</div>
        <div class="progress-container"><div id="over7Progress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="over7Percent">0%</div>
      </div>
      <div id="waitingResponseCard" class="dashboard-card new-card">
        <h3>Call (รอตรวจสอบ)</h3>
        <div class="value" id="callsWaitingResponse">0</div>
        <div class="progress-container"><div id="waitingResponseProgress" class="progress-bar" style="width: 0%;"></div></div>
        <div class="progress-text" id="waitingResponsePercent">0%</div>
      </div>
      <div id="maxCard" class="dashboard-card max-card">
        <h3>Call ค้างสูงสุด</h3>
        <div class="value" id="maxPendingUnit">-</div>
      </div>
      <div id="graphCard" class="dashboard-card graph-card">
        <h3><i class="fas fa-chart-line"></i> กราฟสรุป</h3>
        <div class="value"><i class="fas fa-chart-line"></i></div>
      </div>
      <div id="spareSummaryCard" class="dashboard-card spare-card">
        <h3><i class="fas fa-list-alt"></i> สรุปอะไหล่</h3>
        <div class="value"><i class="fas fa-list-alt"></i></div>
      </div>
    </div>
    <!-- Call Type Dashboard Section (ห่อด้วย container ใหม่เพื่อกรอบตารางแบบกลุ่ม) -->
    <div class="call-type-table-container">
      <div id="callTypeDashboard" class="dashboard"></div>
    </div>
    <div id="searchContainer">
      <div class="filter-row">
        <label id="employeeFilterLabel" for="employeeFilter" class="modern-label">ศูนย์พื้นที่</label>
        <select id="employeeFilter"><option value="">ทั้งหมด</option></select>
        <div id="ticketCountInfo" class="call-count-box">จำนวน Call: <span id="ticketCountValue">0</span> Call</div>
      </div>
      <div class="filter-row">
        <label id="pendingFilterLabel" for="pendingFilter" class="modern-label">ค้างหน่วยงาน</label>
        <select id="pendingFilter"><option value="">ทั้งหมด</option></select>
        <div id="callCountInfo" class="call-count-box">จำนวนรายการ <span id="callCountValue">0</span> รายการ</div>
      </div>
      <div class="filter-row">
        <label id="stockFilterLabel" for="stockFilter" class="modern-label">คลังตอบ</label>
        <select id="stockFilter"><option value="">ทั้งหมด</option></select>
      </div>
      <div class="filter-row">
        <label id="statusCallFilterLabel" for="statusCallFilter" class="modern-label">Status</label>
        <select id="statusCallFilter"><option value="">ทั้งหมด</option></select>
      </div>
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="ค้นหา Ticket Number, Team, Material, TeamPlant, Brand, Call Type, ค้างหน่วยงาน, ผู้แจ้ง, Nawa, คลังตอบ, StatusCall, วันที่ตอบ..." />
        <button id="searchButton" class="action-button"><i class="fas fa-search"></i> ค้นหา</button>
        <button id="printTableButton" class="action-button"><i class="fas fa-print"></i> พิมพ์</button>
        <button id="excelButton" class="action-button"><i class="fas fa-file-excel"></i> Excel</button>
        <button id="summaryButton" class="action-button"><i class="fas fa-list"></i> สรุปข้อมูล</button>
        <button id="settingButton" class="action-button"><i class="fas fa-cog"></i> ตั้งค่า</button>
      </div>
    </div>
    <div class="table-container">
      <table id="data-table">
        <thead>
          <tr>
            <th class="sortable" data-column="DayRepair">ผ่านมา <span class="arrow"></span></th>
            <th class="sortable" data-column="DateTime">วันที่แจ้ง <span class="arrow"></span></th>
            <th class="sortable" data-column="Ticket Number">Ticket Number <span class="arrow"></span></th>
            <th class="sortable" data-column="Brand">Brand <span class="arrow"></span></th>
            <th class="sortable" data-column="Call Type">Call Type <span class="arrow"></span></th>
            <th class="sortable" data-column="Team">Team <span class="arrow"></span></th>
            <th class="sortable" data-column="TeamPlant">ศูนย์พื้นที่ <span class="arrow"></span></th>
            <th class="sortable" data-column="ค้างหน่วยงาน">ค้างหน่วยงาน <span class="arrow"></span></th>
            <th class="sortable" data-column="Material">Material <span class="arrow"></span></th>
            <th class="sortable" data-column="Description">Description <span class="arrow"></span></th>
            <th class="sortable" data-column="Nawa">นวนคร <span class="arrow"></span></th>
            <th class="sortable" data-column="Vipa">วิภาวดี <span class="arrow"></span></th>
            <th class="sortable" data-column="Request">นอกรอบ <span class="arrow"></span></th>
            <th class="sortable" data-column="QtyPlant">ศูนย์พื้นที่ <span class="arrow"></span></th>
            <th class="sortable" data-column="คลังตอบ">คลังตอบ <span class="arrow"></span></th>
            <th class="sortable" data-column="StatusCall">Status <span class="arrow"></span></th>
            <th class="sortable" data-column="วันที่ตอบ">วันที่ตอบ <span class="arrow"></span></th>
            <th class="sortable" data-column="UserAns">ผู้แจ้ง <span class="arrow"></span></th>
            <th class="sortable" data-column="Answer1">แจ้งผล <span class="arrow"></span></th>
            <th>ดูรายละเอียด</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Modals -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">×</span>
        <button class="order-button" onclick="orderModalContent()">
          <i class="fas fa-shopping-cart"></i>
          <span>Order</span>
        </button>
        <button class="print-button" onclick="printModalContent()">
          <i class="fas fa-print"></i>
          <span>พิมพ์</span>
        </button>
        <h2>รายละเอียด</h2>
        <div id="modalContent"></div>
      </div>
    </div>
    <div id="graphModal" class="modal">
      <div class="graph-modal-content">
        <span class="close" id="closeGraphModal">×</span>
        <h2>จำนวน Call ตามค้างหน่วยงานและสถานะ</h2>
        <canvas id="teamChart" style="max-height: 400px;"></canvas>
        <div id="graphWarning"></div>
      </div>
    </div>
    <div id="summaryModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeSummaryModal">×</span>
        <button class="print-button" onclick="printSummaryContent()">
          <i class="fas fa-print"></i>
          <span>พิมพ์สรุป</span>
        </button>
        <h2>สรุปข้อมูล Call ค้าง</h2>
        <div id="summaryContent"></div>
      </div>
    </div>
    <div id="spareSummaryModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeSpareSummaryModal">×</span>
        <button class="print-button" onclick="printSpareSummaryContent()">
          <i class="fas fa-print"></i>
          <span>พิมพ์สรุปอะไหล่</span>
        </button>
        <h2>สรุปอะไหล่ (รอของเข้า)</h2>
        <div id="spareSummaryContent"></div>
      </div>
    </div>
    <div id="settingModal" class="modal">
      <div class="modal-content setting-modal-content">
        <span class="close" id="closeSettingModal">×</span>
        <h2>ตั้งค่า</h2>
        <div>
          <div class="theme-option">
            <input type="radio" id="darkTheme" name="theme" value="dark">
            <label for="darkTheme">ธีมมืด (สีซีด)</label>
          </div>
          <div class="theme-option">
            <input type="radio" id="lightTheme" name="theme" value="light" checked>
            <label for="lightTheme">ธีมสว่าง</label>
          </div>
        </div>
      </div>
    </div>
    <div class="pagination">
      <button id="firstPage"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
      <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
      <div id="pageNumbers"></div>
      <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
      <button id="lastPage"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></button>
      <div class="items-per-page">
        <label for="itemsPerPage">รายการต่อหน้า:</label>
        <select id="itemsPerPage">
          <option value="10">10 รายการ</option>
          <option value="20" selected>20 รายการ</option>
          <option value="30">30 รายการ</option>
        </select>
      </div>
    </div>
  </div>
  <script>
    // Login-related variables and functions
    const loginModal = document.getElementById("loginModal");
    const appContent = document.getElementById("appContent");
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const rememberMeInput = document.getElementById("rememberMe");
    const errorMessage = document.getElementById("errorMessage");
    const togglePassword = document.getElementById("togglePassword");
    const userInfoInMenu = document.getElementById("userInfoInMenu");
    const displayUserNameInMenu = document.getElementById("displayUserNameInMenu");
    const displayUnit = document.getElementById("displayUnit");
    const displayPlant = document.getElementById("displayPlant");
    const logoutButtonInMenu = document.getElementById("logoutButtonInMenu");
    const themeButton = document.getElementById("themeButton");
    const hamburgerIcon = document.getElementById("hamburgerIcon");
    const settingsDropdown = document.getElementById("settingsDropdown");
    const employeeSheetID = '1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw';
    const employeeSheetName = 'EmployeeWeb';
    const employeeUrl = `https://opensheet.elk.sh/${employeeSheetID}/${employeeSheetName}`;
    // Toggle password visibility
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye');
      togglePassword.classList.toggle('fa-eye-slash');
    });
    // Hamburger Menu Toggle
    hamburgerIcon.addEventListener('click', () => {
      settingsDropdown.classList.toggle('show');
    });
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!settingsDropdown.contains(e.target) && !hamburgerIcon.contains(e.target)) {
        settingsDropdown.classList.remove('show');
      }
    });
    // Handle login form submission
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      errorMessage.style.display = 'none';
      // Basic input validation
      if (!username || username.length !== 7 || !username.startsWith('7')) {
        showError('รหัสพนักงานต้องเป็น 7 หลักและเริ่มต้นด้วย 7');
        return;
      }
      if (!password || password.length !== 4) {
        showError('รหัสผ่านต้องเป็น 4 หลัก');
        return;
      }
      const derivedPassword = username.slice(-4);
      if (password !== derivedPassword) {
        showError('รหัสผ่านไม่ถูกต้อง (ใช้ 4 หลักสุดท้ายของรหัสพนักงาน)');
        return;
      }
      // Show loading in modal
      showLoading();
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
        const response = await fetch(employeeUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) {
          throw new Error(response.status === 403 ? 'CORS/Access Denied' : 'Fetch Failed');
        }
        const employees = await response.json();
        // Find user
        const user = employees.find(emp => emp.IDRec === username);
        if (!user || !user.Name) {
          throw new Error('User not found');
        }
        // Save session
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('username', username);
        localStorage.setItem('userName', user.Name);
        localStorage.setItem('userUnit', user.หน่วยงาน || '-');
        localStorage.setItem('userPlant', user.Plant || '-');
        if (rememberMeInput.checked) {
          localStorage.setItem('rememberMe', 'true');
          localStorage.setItem('savedUsername', username);
        }
        // Success
        hideLoading();
        loginModal.classList.add('hidden');
        appContent.classList.add('logged-in');
        displayUserNameInMenu.textContent = user.Name;
        displayUnit.textContent = user.หน่วยงาน || '-';
        displayPlant.textContent = user.Plant || '-';
        userInfoInMenu.style.display = 'block';
        document.getElementById('searchInput').focus(); // Auto-focus search
        // Load app data
        initApp();
      } catch (error) {
        hideLoading();
        if (error.name === 'AbortError') {
          Swal.fire('Timeout', 'การเชื่อมต่อช้าเกิน 30 วินาที กรุณาลองใหม่', 'error');
        } else if (error.message.includes('403') || error.message.includes('CORS')) {
          Swal.fire('Access Denied', 'ไม่สามารถเข้าถึงข้อมูลพนักงานได้ กรุณาติดต่อผู้ดูแล', 'error');
        } else if (error.message === 'User not found') {
          showError('ไม่พบข้อมูลพนักงานนี้');
        } else {
          Swal.fire('Network Error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่', 'error');
        }
      }
    });
    // Show error in modal
    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
    }
    // Check login status on load
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      if (isLoggedIn) {
        const username = localStorage.getItem('username');
        const userName = localStorage.getItem('userName');
        const userUnit = localStorage.getItem('userUnit');
        const userPlant = localStorage.getItem('userPlant');
        if (username && userName) {
          // Validate with derived password (quick check)
          const derivedPassword = username.slice(-4);
          // Assume valid if stored; in production, re-validate with fetch if needed
          loginModal.classList.add('hidden');
          appContent.classList.add('logged-in');
          displayUserNameInMenu.textContent = userName;
          displayUnit.textContent = userUnit || '-';
          displayPlant.textContent = userPlant || '-';
          userInfoInMenu.style.display = 'block';
          if (localStorage.getItem('rememberMe') === 'true') {
            usernameInput.value = localStorage.getItem('savedUsername') || '';
          }
          document.getElementById('searchInput').focus();
          initApp();
          return true;
        }
      }
      // Show login modal
      loginModal.classList.remove('hidden');
      usernameInput.focus();
      return false;
    }
    // Handle logout
    logoutButtonInMenu.addEventListener('click', handleLogout);
    function handleLogout() {
      localStorage.clear(); // Clear all keys
      settingsDropdown.classList.remove('show');
      location.reload(); // Reload to show login
    }
    // Theme button in menu
    themeButton.addEventListener('click', () => {
      settingModal.style.display = 'block';
      settingsDropdown.classList.remove('show');
    });
    // Enter key support for login
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !appContent.classList.contains('logged-in')) {
        loginForm.dispatchEvent(new Event('submit'));
      }
    });
    // App Initialization (original code wrapped)
    let allData = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let sortConfig = { column: 'DayRepair', direction: 'desc' };
    let teamChart = null;
    let dashboardFilter = null;
    let callTypeCards = {};
    let currentTicketNumber = null;
    let currentRowData = null;
    const sheetID = '1dzE4Xjc7H0OtNUmne62u0jFQT-CiGsG2eBo-1v6mrZk';
    const sheetName = 'Coll_Stock';
    const url = `https://opensheet.elk.sh/${sheetID}/${sheetName}`;
    const updateSheetName = 'Update';
    const updateUrl = `https://opensheet.elk.sh/${sheetID}/${updateSheetName}`;
    const modal = document.getElementById("detailModal");
    const graphModal = document.getElementById("graphModal");
    const summaryModal = document.getElementById("summaryModal");
    const spareSummaryModal = document.getElementById("spareSummaryModal");
    const settingModal = document.getElementById("settingModal");
    const modalContent = document.getElementById("modalContent");
    const closeModal = document.getElementById("closeModal");
    const closeGraphModal = document.getElementById("closeGraphModal");
    const closeSummaryModal = document.getElementById("closeSummaryModal");
    const closeSpareSummaryModal = document.getElementById("closeSpareSummaryModal");
    const closeSettingModal = document.getElementById("closeSettingModal");
    const employeeFilter = document.getElementById("employeeFilter");
    const pendingFilter = document.getElementById("pendingFilter");
    const stockFilter = document.getElementById("stockFilter");
    const statusCallFilter = document.getElementById("statusCallFilter");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const printTableButton = document.getElementById("printTableButton");
    const excelButton = document.getElementById("excelButton");
    const summaryButton = document.getElementById("summaryButton");
    const settingButton = document.getElementById("settingButton");
    const tableBody = document.querySelector("#data-table tbody");
    const pageNumbersContainer = document.getElementById("pageNumbers");
    const firstPageButton = document.getElementById("firstPage");
    const prevPageButton = document.getElementById("prevPage");
    const nextPageButton = document.getElementById("nextPage");
    const lastPageButton = document.getElementById("lastPage");
    const itemsPerPageSelect = document.getElementById("itemsPerPage");
    const graphWarning = document.getElementById("graphWarning");
    const summaryContent = document.getElementById("summaryContent");
    const spareSummaryContent = document.getElementById("spareSummaryContent");
    const updateValueSpan = document.getElementById("updateValue");
    const loadingDiv = document.getElementById("loading");
    const callTypeDashboard = document.getElementById("callTypeDashboard");
    // Dashboard cards
    const totalCard = document.getElementById("totalCard");
    const pendingCard = document.getElementById("pendingCard");
    const successCard = document.getElementById("successCard");
    const waitingResponseCard = document.getElementById("waitingResponseCard");
    const over7Card = document.getElementById("over7Card");
    const requestCard = document.getElementById("requestCard");
    const nawaCard = document.getElementById("nawaCard");
    const maxCard = document.getElementById("maxCard");
    const graphCard = document.getElementById("graphCard");
    const spareSummaryCard = document.getElementById("spareSummaryCard");
    function showLoading() {
      loadingDiv.classList.add('show');
    }
    function hideLoading() {
      loadingDiv.classList.remove('show');
    }
    function getCleanTeamPlant(tp) {
      return (tp || "").replace(/Stock\s*/gi, '').trim();
    }
    /** ฟังก์ชันจัดการธีม */
    function setTheme(theme) {
      document.body.className = theme === 'dark' ? 'dark-theme' : '';
      localStorage.setItem('theme', theme);
    }
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      setTheme(savedTheme);
      document.querySelector(`input[value="${savedTheme}"]`).checked = true;
    }
    // Event listeners สำหรับ setting modal
    settingButton.addEventListener('click', () => { settingModal.style.display = 'block'; });
    closeSettingModal.onclick = () => { settingModal.style.display = 'none'; };
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        setTheme(e.target.value);
      });
    });
    window.addEventListener('click', (e) => {
      if (e.target === settingModal) {
        settingModal.style.display = 'none';
      }
    });
    function updateActiveCard(cardId) {
      // Clear active from all dashboard cards
      document.querySelectorAll('.dashboard-card').forEach(card => card.classList.remove('active'));
      if (cardId) {
        const card = document.getElementById(cardId);
        if (card) card.classList.add('active');
      }
    }
    /** อ่าน Description รองรับสะกดหลายแบบ */
    function getDesc(row) {
      return (row["Description"] ?? row["Discription"] ?? row["Discrtiption"] ?? "-");
    }
    function extractDate(dateTimeStr) {
      if (!dateTimeStr || typeof dateTimeStr !== 'string') return dateTimeStr || "-";
      const match = dateTimeStr.match(/^(\d{2}\/\d{2}\/\d{4})/);
      return match ? match[1] : dateTimeStr;
    }
    function parseDate(dateStr) {
      if (!dateStr || typeof dateStr !== 'string') return null;
      const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/);
      if (!parts) return null;
      const [, day, month, year, hour, minute, second] = parts;
      return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));
    }
    function getBaseFilteredData() {
      const selectedTeamPlant = employeeFilter.value;
      const selectedPending = pendingFilter.value;
      const selectedStock = stockFilter.value;
      const selectedStatusCall = statusCallFilter.value;
      const keyword = searchInput.value.toLowerCase().trim();
      return allData.filter(row => {
        if (!row) return false;
        const cleanRowTP = getCleanTeamPlant(row["TeamPlant"]);
        return (
          (!selectedTeamPlant || cleanRowTP === selectedTeamPlant) &&
          (!selectedPending || (row["ค้างหน่วยงาน"] || "") === selectedPending) &&
          (!selectedStock || (row["คลังตอบ"] || "") === selectedStock) &&
          (!selectedStatusCall || (row["StatusCall"] || "") === selectedStatusCall) &&
          (!keyword ||
            (row["DayRepair"] || "").toString().toLowerCase().includes(keyword) ||
            (row["DateTime"] || "").toLowerCase().includes(keyword) ||
            (row["Ticket Number"] || "").toLowerCase().includes(keyword) ||
            (row["Brand"] || "").toLowerCase().includes(keyword) ||
            (row["Call Type"] || "").toLowerCase().includes(keyword) ||
            (row["Team"] || "").toLowerCase().includes(keyword) ||
            cleanRowTP.toLowerCase().includes(keyword) ||
            (row["ค้างหน่วยงาน"] || "").toLowerCase().includes(keyword) ||
            (row["Material"] || "").toLowerCase().includes(keyword) ||
            (getDesc(row) || "").toLowerCase().includes(keyword) ||
            (row["Nawa"] || "").toLowerCase().includes(keyword) ||
            (row["Vipa"] || "").toLowerCase().includes(keyword) ||
            (row["Request"] || "").toLowerCase().includes(keyword) ||
            (row["QtyPlant"] || "").toLowerCase().includes(keyword) ||
            (row["คลังตอบ"] || "").toLowerCase().includes(keyword) ||
            (row["UserAns"] || "").toLowerCase().includes(keyword) ||
            (row["วันที่ตอบ"] || "").toLowerCase().includes(keyword) ||
            (row["StatusCall"] || "").toLowerCase().includes(keyword)
          )
        );
      });
    }
    /** คำนวณเมตริก Dashboard - เปลี่ยนอ้างอิงเป็นค้างหน่วยงาน */
    function calculateDashboardMetrics(data) {
      const ticketSet = new Set();
      const waitingResponseTickets = new Set();
      const pendingTickets = new Set();
      const successTickets = new Set();
      const nawaVipaTickets = new Set();
      const over7Tickets = new Set();
      const requestTickets = new Set();
      const pendingUnitTicketCounts = {};
      data.forEach(row => {
        const ticket = row["Ticket Number"];
        if (!ticket || ticketSet.has(ticket)) return;
        ticketSet.add(ticket);
        if ((row["คลังตอบ"] || "") === "รอตรวจสอบ") {
          waitingResponseTickets.add(ticket);
        }
        const dayRepair = parseFloat(row["DayRepair"]) || 0;
        if (dayRepair > 7) {
          over7Tickets.add(ticket);
        }
        const status = row["StatusCall"];
        if (status === "รอของเข้า") {
          pendingTickets.add(ticket);
        } else if (status === "สำเร็จ") {
          successTickets.add(ticket);
        } else if (status === "เบิกนวนคร" || status === "เบิกวิภาวดี") {
          nawaVipaTickets.add(ticket);
        }
        if (!row["Material"] || row["Material"] === "" || row["Material"] === "-") {
          requestTickets.add(ticket);
        }
        const pendingUnit = row["ค้างหน่วยงาน"] || "ไม่ระบุ";
        if (!pendingUnitTicketCounts[pendingUnit]) pendingUnitTicketCounts[pendingUnit] = new Set();
        pendingUnitTicketCounts[pendingUnit].add(ticket);
      });
      const totalCalls = ticketSet.size;
      const callsPending = pendingTickets.size;
      const callsSuccess = successTickets.size;
      const callsNawaVipa = nawaVipaTickets.size;
      const callsWaitingResponse = waitingResponseTickets.size;
      const callsOver7 = over7Tickets.size;
      const callsRequest = requestTickets.size;
      const pendingUnitCounts = Object.fromEntries(Object.entries(pendingUnitTicketCounts).map(([pendingUnit, set]) => [pendingUnit, set.size]));
      const maxPendingUnitEntry = Object.entries(pendingUnitCounts).length > 0 ? Object.entries(pendingUnitCounts).reduce((a, b) => a[1] > b[1] ? a : b) : null;
      const maxPendingUnit = maxPendingUnitEntry ? maxPendingUnitEntry[0] : '-';
      return {
        totalCalls,
        callsPending,
        callsSuccess,
        callsNawaVipa,
        callsWaitingResponse,
        callsOver7,
        callsRequest,
        maxPendingUnit
      };
    }
    function calculateCallTypeMetrics(data) {
      const ticketSet = new Set();
      const callTypeCounts = {};
      data.forEach(row => {
        const ticket = row["Ticket Number"];
        if (!ticket || ticketSet.has(ticket)) return;
        ticketSet.add(ticket);
        const ct = row["Call Type"] || 'อื่นๆ';
        if (!callTypeCounts[ct]) callTypeCounts[ct] = 0;
        callTypeCounts[ct]++;
      });
      return { callTypeCounts, total: ticketSet.size };
    }
    function updateCallTypeDashboard(data) {
      const metrics = calculateCallTypeMetrics(data);
      const { callTypeCounts, total } = metrics;
      callTypeDashboard.innerHTML = '';
      callTypeCards = {};
      Object.entries(callTypeCounts).forEach(([type, count]) => {
        const card = document.createElement('div');
        card.id = `calltype_${type}Card`;
        card.className = 'dashboard-card';
        let colorClass = 'calltype-other-card';
        if (type === 'P') colorClass = 'calltype-p-card';
        else if (type === 'C') colorClass = 'calltype-c-card';
        else if (type === 'B') colorClass = 'calltype-b-card';
        else if (type === 'U') colorClass = 'calltype-u-card';
        card.classList.add(colorClass);
        const percent = total > 0 ? (count / total * 100).toFixed(0) : 0;
        card.innerHTML = `
          <h3>${type}</h3>
          <div class="value">${count}</div>
          <div class="progress-container"><div class="progress-bar" style="width: ${percent}%;"></div></div>
          <div class="progress-text">${percent}%</div>
        `;
        card.addEventListener('click', () => {
          dashboardFilter = `calltype_${type}`;
          filterAndRenderTable();
        });
        callTypeDashboard.appendChild(card);
        callTypeCards[type] = card;
      });
      // Set active state for the current call type filter if applicable
      if (dashboardFilter && dashboardFilter.startsWith('calltype_')) {
        const activeType = dashboardFilter.split('_')[1];
        const activeCard = callTypeCards[activeType];
        if (activeCard) {
          activeCard.classList.add('active');
        }
      }
    }
    function fetchUpdateDate() {
      fetch(updateUrl)
        .then(r => r.json())
        .then(updateData => {
          if (!updateData || updateData.length === 0) { updateValueSpan.textContent = '-'; return; }
          let maxDate = null, maxDateStr = '';
          updateData.forEach(row => {
            const dateStr = row['Date'];
            const parsedDate = parseDate(dateStr);
            if (parsedDate && (!maxDate || parsedDate > maxDate)) { maxDate = parsedDate; maxDateStr = dateStr; }
          });
          updateValueSpan.textContent = maxDateStr || '-';
        })
        .catch(() => { updateValueSpan.textContent = '-'; });
    }
    function escapeCSVValue(value) {
      if (value == null) return '""';
      const stringValue = value.toString();
      if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
        return `"${stringValue.replace(/"/g, '""')}"`;
      }
      return stringValue;
    }
    function exportToCSV() {
      if (!allData || allData.length === 0) { alert("ไม่มีข้อมูลในระบบสำหรับการส่งออก CSV"); return; }
      const baseFilteredData = getBaseFilteredData();
      let filteredData = [...baseFilteredData];
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "รอของเข้า");
              break;
            case 'success':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "สำเร็จ");
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = filteredData.filter(row => {
                const status = row["StatusCall"] || "";
                return status === "เบิกนวนคร" || status === "เบิกวิภาวดี";
              });
              break;
          }
        }
      }
      if (filteredData.length === 0) { alert("ไม่มีข้อมูลที่ตรงกับเงื่อนไขการกรอง"); return; }
      filteredData.sort((a, b) => {
        let dayA = parseFloat(a["DayRepair"]) || 0;
        let dayB = parseFloat(b["DayRepair"]) || 0;
        let ticketA = a["Ticket Number"] || "";
        let ticketB = b["Ticket Number"] || "";
        if (dayA !== dayB) return dayB - dayA;
        return ticketA.localeCompare(ticketB);
      });
      const columns = ["DayRepair","DateTime","Ticket Number","Brand","Call Type","Team","TeamPlant","ค้างหน่วยงาน","Material","Description","วันที่ตอบ","UserAns"];
      const displayColumns = { "DayRepair":"ผ่านมา","DateTime":"วันที่แจ้ง","Ticket Number":"Ticket Number","Brand":"Brand","Call Type":"Call Type","Team":"Team","TeamPlant":"ศูนย์พื้นที่","ค้างหน่วยงาน":"ค้างหน่วยงาน","Material":"Material","Description":"Description","วันที่ตอบ":"วันที่ตอบ","UserAns":"ผู้แจ้ง" };
      const csvRows = [];
      csvRows.push(columns.map(col => `"${displayColumns[col]}"`).join(','));
      filteredData.forEach(row => {
        const rowData = columns.map(col => {
          let value;
          if (col === "Description") value = getDesc(row);
          else if (col === "DateTime") value = extractDate(row[col] || "-");
          else value = row[col] || "-";
          if (col === "DayRepair") value = isNaN(parseFloat(value)) ? "-" : parseFloat(value).toFixed(0);
          return escapeCSVValue(value);
        });
        csvRows.push(rowData.join(','));
      });
      const csvContent = csvRows.join('\n');
      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `report_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
    }
    /** พิมพ์จากโมดัล: ใช้ currentRowData ให้ตรงกับรายละเอียดที่เห็น */
    function printModalContent() {
      if (!currentRowData) { alert("ไม่พบข้อมูลสำหรับการพิมพ์"); return; }
      const modalData = currentRowData;
      const desc = getDesc(modalData);
      const stickerContent = `
        <div><span class="label">ผ่านมา:</span> <span class="value">${modalData["DayRepair"] || "-"}</span></div>
        <div><span class="label">Team:</span> <span class="value team-brand">${modalData["Team"] || "-"}</span></div>
        <div><span class="label">Brand:</span> <span class="value team-brand">${modalData["Brand"] || "-"}</span></div>
        <div><span class="label">Call Type:</span> <span class="value">${modalData["Call Type"] || "-"}</span></div>
        <div><span class="label">วันที่แจ้ง:</span> <span class="value">${extractDate(modalData["DateTime"] || "-")}</span></div>
        <div><span class="label">Ticket Number:</span> <span class="value">${modalData["Ticket Number"] || "-"}</span></div>
        <div><span class="label">ทีมพื้่นที่:</span> <span class="value">${getCleanTeamPlant(modalData["TeamPlant"]) || "-"}</span></div>
        <div><span class="label">Material:</span> <span class="value">${modalData["Material"] || "-"}</span></div>
        <div class="description"><span class="label">Description:</span> <span class="value">${desc || "-"}</span></div>
        <div><span class="label">วันที่ตอบ:</span> <span class="value">${modalData["วันที่ตอบ"] || "-"}</span></div>
        <div><span class="label">ผู้แจ้ง:</span> <span class="value">${modalData["UserAns"] || "-"}</span></div>
        <div><span class="label">แจ้งผล:</span> <span class="value">${modalData["Answer1"] || "-"}</span></div>
      `;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>พิมพ์รายละเอียด</title>
            <style>
              body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; }
              .sticker { width: 80mm; height: 100mm; border: 1px solid #000; padding: 2mm; box-sizing: border-box; font-size: 13pt; line-height: 1.3; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; page-break-after: always; }
              .sticker div { margin-bottom: 1.5mm; overflow-wrap: break-word; }
              .sticker div.description { flex: 1; }
              .sticker .label { font-weight: bold; color: #000; font-size: 14pt; }
              .sticker .value { color: #000; }
              .sticker .value.team-brand { font-size: 20pt; font-weight: bold; }
              h2 { font-size: 14pt; color: #000; margin: 1.5mm 0; }
              @media print {
                body { margin: 0; }
                @page { size: 80mm 100mm; margin: 0; }
              }
            </style>
          </head>
          <body onload="window.print()">
            <div class="sticker">
              <h2>รายละเอียด</h2>
              ${stickerContent}
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
    }
    /** Order จากโมดัล: แสดง Popup ด้วย SweetAlert2 */
    function orderModalContent() {
  if (!currentRowData) {
    Swal.fire('ผิดพลาด', 'ไม่พบข้อมูลสำหรับการ Order', 'error');
    return;
  }

  // ตรวจสอบสิทธิ์
  if (!canUserOrder()) {
    Swal.fire({
      icon: 'warning',
      title: 'ไม่มีสิทธิ์ใช้งาน',
      text: 'ฟังก์ชันสั่งซื้ออะไหล่สงวนไว้สำหรับ แผนกคลัง Spare part วิภาวดี 62 และ แผนกคลังวัตถุดิบ เท่านั้น',
      confirmButtonText: 'ตกลง'
    });
    return;
  }

  const modalData     = currentRowData;
  const desc           = getDesc(modalData);
  const userName       = localStorage.getItem('userName') || 'ไม่ระบุ';
  const userPlant      = localStorage.getItem('userPlant') || '-';
  const employeeCode   = localStorage.getItem('username') || '-'; // รหัสพนักงาน 7 หลัก
  const customer       = `${modalData["Team"] || "-"} (${modalData["Brand"] || "-"})`;
  const defaultPhone   = "0909082850";
// ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
  // URL ของ Google Apps Script Web App (เปลี่ยนเป็นของคุณจริง ๆ)
  const gasUrl = 'https://script.google.com/macros/s/AKfycbwVF2HAC8EYARt6Ku2ThUZWgeVxXWDhRQCQ0vCgGvilEMg8h5Hg3BlrcJJn2qMMqpGr/exec';
  // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
      Swal.fire({
        title: 'เบิกอะไหล่นอกรอบ',
        html: `
          <div style="text-align: left; font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <h3 style="margin: 0 0 10px 0; text-align: center; color: #fff; font-size: 18px;"><i class="fas fa-shopping-cart"></i> รายละเอียดการเบิก</h3>
              <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Material:</strong>
                  <span style="text-align: right; flex: 1;">${modalData["Material"] || "-"}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Description:</strong>
                  <span style="text-align: right; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${desc || "-"}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Ticket Number:</strong>
                  <span style="text-align: right; flex: 1;">${modalData["Ticket Number"] || "-"}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Call Type:</strong>
                  <span style="text-align: right; flex: 1;">${modalData["Call Type"] || "-"}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">User:</strong>
                  <span style="text-align: right; flex: 1;">${userName}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Plant:</strong>
                  <span style="text-align: right; flex: 1;">${userPlant}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">Customer:</strong>
                  <span style="text-align: right; flex: 1; font-weight: bold; color: #fff;">${customer}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                  <strong style="color: #ffd700;">เบอร์ติดต่อ:</strong>
                  <span style="text-align: right; flex: 1; font-weight: bold; color: #fff;">${defaultPhone}</span>
                </div>
              </div>
            </div>
            <label for="quantity" style="display: block; margin-top: 10px; font-weight: bold; color: #fff; font-size: 14px;">จำนวน:</label>
            <input type="number" id="quantity" value="1" min="1" style="width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 8px; background: rgba(255,255,255,0.9); font-size: 16px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
          </div>
        `,
      showCancelButton: true,
    confirmButtonText: 'ยืนยัน',
    cancelButtonText: 'ยกเลิก',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#dc3545',
    preConfirm: () => {
      const quantity = document.getElementById('quantity').value.trim();
      if (!quantity || parseInt(quantity) < 1) {
        Swal.showValidationMessage('กรุณากรอกจำนวนที่ถูกต้อง (อย่างน้อย 1)');
        return false;
      }
      return { quantity };
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      const { quantity } = result.value;
Swal.fire({
        title: 'กำลังบันทึกข้อมูล...',
        html: '<div class="spinner" style="width:50px;height:50px;margin:20px auto;"></div>',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // ข้อมูลที่จะส่งไป Google Sheet
      const jsonPayload = {
        material      : modalData["Material"] || "-",
        description   : desc || "-",
        quantity      : quantity,
        contact       : defaultPhone,                 // เบอร์ติดต่อ
        employeeCode  : employeeCode,                 // รหัสพนักงาน
        team          : customer,                     // Team (Brand)
        employeeName  : userName,                     // ชื่อผู้สั่ง
        callNumber    : modalData["Ticket Number"] || "-", 
        callType      : modalData["Call Type"] || "-",
        remark        : "",                           // ถ้ามี remark เพิ่มเติมให้ใส่ตรงนี้
        status        : "รอเบิก"                   // ค่าคงที่ตามที่คุณต้องการ
      };

      try {
        // ส่งข้อมูลไป GAS
        const response = await fetch(gasUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `action=insertRequest&payload=${encodeURIComponent(JSON.stringify(jsonPayload))}`
        });

       const result = await response.json();
console.log('GAS response:', result); // ไว้ debug ได้ จะลบทีหลังก็ได้

if (result.status === "success") {
  Swal.fire({
    icon: 'success',
    title: 'สั่งซื้อสำเร็จ!',
    html: `<p>บันทึกข้อมูลเรียบร้อยแล้ว<br>Material: ${jsonPayload.material}<br>จำนวน: ${quantity}</p>`,
    timer: 3000,
    timerProgressBar: true
  });
} else {
  // เผื่อ GAS ส่ง error กลับมาใน data หรือ error
  throw new Error(result.data || result.error || 'บันทึกไม่สำเร็จ');
}


      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่หรือติดต่อผู้ดูแลระบบ'
        });
      }
    }
  });
}
    /** พิมพ์สติ๊กเกอร์จากหน้าหลัก */
    function printTable() {
      const baseFilteredData = getBaseFilteredData();
      let filteredData = [...baseFilteredData];
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "รอของเข้า");
              break;
            case 'success':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "สำเร็จ");
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = filteredData.filter(row => {
                const status = row["StatusCall"] || "";
                return status === "เบิกนวนคร" || status === "เบิกวิภาวดี";
              });
              break;
          }
        }
      }
      if (filteredData.length === 0) { alert("ไม่มีข้อมูลที่ตรงกับเงื่อนไขการค้นหา"); return; }
      filteredData.sort((a, b) => {
        let dayA = parseFloat(a["DayRepair"]) || 0;
        let dayB = parseFloat(b["DayRepair"]) || 0;
        let ticketA = a["Ticket Number"] || "";
        let ticketB = b["Ticket Number"] || "";
        if (dayA !== dayB) return dayB - dayA;
        return ticketA.localeCompare(ticketB);
      });
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const paginatedData = filteredData.slice(startIdx, endIdx);
      const stickersHtml = paginatedData.map(row => {
        const desc = getDesc(row);
        return `
          <div class="sticker">
            <div><span class="label">ผ่านมา:</span> <span class="value">${row["DayRepair"] || "-"}</span></div>
            <div><span class="label">Team:</span> <span class="value team-brand">${row["Team"] || "-"}</span></div>
            <div><span class="label">Brand:</span> <span class="value team-brand">${row["Brand"] || "-"}</span></div>
            <div><span class="label">Call Type:</span> <span class="value">${row["Call Type"] || "-"}</span></div>
            <div><span class="label">วันที่แจ้ง:</span> <span class="value">${extractDate(row["DateTime"] || "-")}</span></div>
            <div><span class="label">Ticket Number:</span> <span class="value">${row["Ticket Number"] || "-"}</span></div>
            <div><span class="label">ศูนย์พื้นที่:</span> <span class="value">${getCleanTeamPlant(row["TeamPlant"]) || "-"}</span></div>
            <div><span class="label">Material:</span> <span class="value">${row["Material"] || "-"}</span></div>
            <div class="description"><span class="label">Description:</span> <span class="value">${desc || "-"}</span></div>
            <div><span class="label">วันที่ตอบ:</span> <span class="value">${row["วันที่ตอบ"] || "-"}</span></div>
            <div><span class="label">ผู้แจ้ง:</span> <span class="value">${row["UserAns"] || "-"}</span></div>
            <div><span class="label">แจ้งผล:</span> <span class="value">${row["Answer1"] || "-"}</span></div>
          </div>
        `;
      }).join('');
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>พิมพ์สติ๊กเกอร์</title>
            <style>
              body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; }
              .sticker { width: 80mm; height: 100mm; border: 1px solid #000; padding: 2mm; box-sizing: border-box; font-size: 13pt; line-height: 1.3; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; page-break-after: always; }
              .sticker div { margin-bottom: 1.5mm; overflow-wrap: break-word; }
              .sticker div.description { flex: 1; }
              .sticker .label { font-weight: bold; color: #000; font-size: 14pt; }
              .sticker .value { color: #000; }
              .sticker .value.team-brand { font-size: 16pt; font-weight: bold; }
              @media print {
                body { margin: 0; }
                @page { size: 80mm 100mm; margin: 0; }
              }
            </style>
          </head>
          <body onload="window.print()">
            ${stickersHtml}
          </body>
        </html>
      `);
      printWindow.document.close();
    }
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
    }
    const totalPlugin = {
      id: 'totalLabel',
      afterDatasetsDraw: function(chart) {
        const ctx = chart.ctx;
        ctx.save();
        ctx.font = 'bold 14px sans-serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.shadowColor = 'rgba(0,0,0,0.1)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;
        chart.data.labels.forEach((label, index) => {
          let total = 0;
          let topY = chart.chartArea.bottom;
          chart.data.datasets.forEach((dataset) => {
            const value = dataset.data[index] || 0;
            total += value;
            if (value > 0) {
              const dsIndex = chart.data.datasets.findIndex(d => d === dataset);
              const meta = chart.getDatasetMeta(dsIndex);
              const bar = meta.data[index];
              topY = Math.min(topY, bar.y);
            }
          });
          if (total > 0) {
            const x = chart.scales.x.getPixelForValue(index);
            ctx.fillText(total.toString(), x, topY - 10);
          }
        });
        ctx.restore();
      }
    };
    function showGraph() {
      const baseFilteredData = getBaseFilteredData();
      let filteredData = [...baseFilteredData];
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "รอของเข้า");
              break;
            case 'success':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "สำเร็จ");
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = filteredData.filter(row => {
                const status = row["StatusCall"] || "";
                return status === "เบิกนวนคร" || status === "เบิกวิภาวดี";
              });
              break;
          }
        }
      }
      if (filteredData.length === 0) {
        graphWarning.textContent = "ไม่มีข้อมูลสำหรับแสดงกราฟ";
        graphModal.style.display = "block";
        return;
      }
      const pivotData = {};
      const pendingUnitsRaw = filteredData.map(row => row["ค้างหน่วยงาน"] || "ไม่ระบุ");
      let pendingUnits = [...new Set(pendingUnitsRaw)].sort();
      const statusCalls = [...new Set(filteredData.map(row => row["StatusCall"] || "ไม่ระบุ"))].sort();
      pendingUnits.forEach(pendingUnit => {
        pivotData[pendingUnit] = {};
        statusCalls.forEach(status => { pivotData[pendingUnit][status] = 0; });
      });
      const ticketCounts = {};
      filteredData.forEach(row => {
        const ticket = row["Ticket Number"];
        if (!ticketCounts[ticket]) {
          const pendingUnit = row["ค้างหน่วยงาน"] || "ไม่ระบุ";
          const status = row["StatusCall"] || "ไม่ระบุ";
          pivotData[pendingUnit][status]++;
          ticketCounts[ticket] = true;
        }
      });
      // ✅ คำนวณผลรวมสำหรับแต่ละค้างหน่วยงานและเรียงลำดับจากมากไปน้อย
      const pendingUnitTotals = {};
      pendingUnits.forEach(pendingUnit => {
        pendingUnitTotals[pendingUnit] = statusCalls.reduce((sum, status) => sum + (pivotData[pendingUnit][status] || 0), 0);
      });
      pendingUnits.sort((a, b) => pendingUnitTotals[b] - pendingUnitTotals[a]);
      const colors = {
        "รอของเข้า": '#e74c3c',
        "ระหว่างขนส่ง": '#27ae60',
        "เบิกนวนคร": '#3498db',
        "เบิกวิภาวดี": '#f39c12',
        "ไม่ระบุ": '#95a5a6'
      };
      const datasets = statusCalls.filter(status => status !== "ไม่ระบุ" && Object.values(pivotData).some(pu => pu[status] > 0)).map(status => {
        const colorKey = status === "สำเร็จ" ? "ระหว่างขนส่ง" : status;
        const rgb = hexToRgb(colors[colorKey] || '#6c757d');
        return {
          label: status === "สำเร็จ" ? "ระหว่างขนส่ง" : status,
          data: pendingUnits.map(pendingUnit => pivotData[pendingUnit][status] || 0),
          borderColor: colors[colorKey] || '#6c757d',
          backgroundColor: rgb ? `rgba(${rgb}, 0.8)` : '#6c757d',
          borderWidth: 2,
          borderRadius: 4,
          stack: 'CallStack'
        };
      });
      let limitedUnits = pendingUnits;
      let warningMessage = "";
      if (pendingUnits.length > 50) {
        limitedUnits = pendingUnits.slice(0, 50);
        warningMessage = `แสดงเฉพาะ 50 ค้างหน่วยงานแรกจากทั้งหมด ${pendingUnits.length} เนื่องจากข้อจำกัดด้านการแสดงผล`;
      }
      const limitedDatasets = datasets.map(ds => ({
        ...ds,
        data: limitedUnits.map(pendingUnit => pivotData[pendingUnit][ds.label === "ระหว่างขนส่ง" ? "สำเร็จ" : ds.label] || 0)
      }));
      graphWarning.textContent = warningMessage;
      if (limitedUnits.length === 0) { graphWarning.textContent = "ไม่มีข้อมูลสำหรับแสดงกราฟ"; graphModal.style.display = "block"; return; }
      if (teamChart) teamChart.destroy();
      const ctx = document.getElementById('teamChart').getContext('2d');
      teamChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: limitedUnits,
          datasets: limitedDatasets
        },
        options: {
          responsive: true,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animation: {
            duration: 2000,
            easing: 'easeOutQuart'
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          onClick: (event, elements, chart) => {
            if (elements.length > 0) {
              const element = elements[0];
              const index = element.index;
              const pendingUnit = chart.data.labels[index];
              pendingFilter.value = pendingUnit;
              // Reset other filters to show all data for this pendingUnit
              employeeFilter.value = "";
              stockFilter.value = "";
              statusCallFilter.value = "";
              searchInput.value = "";
              dashboardFilter = null;
              updateActiveCard(null);
              filterAndRenderTable();
              // graphModal.style.display = "none"; // ลบการปิด modal เพื่อให้กราฟยังคงแสดงข้อมูลทั้งหมด
            }
          },
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: function(context) {
                  return `ค้างหน่วยงาน: ${context[0].label}`;
                },
                label: function(context) {
                  // ✅ แสดงเฉพาะสถานะที่มีข้อมูล (> 0) เท่านั้น
                  if (context.parsed.y > 0) {
                    return `${context.dataset.label}: ${context.parsed.y} Call`;
                  }
                  return null; // ข้ามการแสดงถ้า = 0
                },
                footer: function(context) {
                  // ✅ คำนวณผลรวมเฉพาะสถานะที่มีข้อมูล (> 0)
                  let total = 0;
                  context.forEach(function(ctx) {
                    if (ctx.parsed.y > 0) {
                      total += ctx.parsed.y;
                    }
                  });
                  return `รวม: ${total} Call`;
                }
              }
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            }
          }
        },
        plugins: [totalPlugin]
      });
      graphModal.style.display = "block";
    }
    function showSummary() {
      const baseFilteredData = getBaseFilteredData();
      let filteredData = [...baseFilteredData];
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "รอของเข้า");
              break;
            case 'success':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "สำเร็จ");
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = filteredData.filter(row => {
                const status = row["StatusCall"] || "";
                return status === "เบิกนวนคร" || status === "เบิกวิภาวดี";
              });
              break;
          }
        }
      }
      const uniqueTickets = [...new Set(filteredData.map(row => row["Ticket Number"]).filter(Boolean))].length;
      const totalCalls = uniqueTickets;
      const pivotData = {};
      const teamPlants = [...new Set(filteredData.map(row => getCleanTeamPlant(row["TeamPlant"] || "ไม่ระบุ")) )].sort();
      const statusCalls = [...new Set(filteredData.map(row => row["StatusCall"] || "ไม่ระบุ"))].sort();
      const pendingUnits = [...new Set(filteredData.map(row => row["ค้างหน่วยงาน"] || "ไม่ระบุ"))].sort();
      const orderedPendingUnits = ["NEC_ยกเลิกผลิต"].filter(unit => pendingUnits.includes(unit));
      teamPlants.forEach(teamPlant => {
        pivotData[teamPlant] = {};
        statusCalls.forEach(status => { pivotData[teamPlant][status] = 0; });
        pendingUnits.forEach(pending => { pivotData[teamPlant][pending] = 0; });
      });
      const ticketCounts = {};
      filteredData.forEach(row => {
        const ticket = row["Ticket Number"];
        if (!ticketCounts[ticket]) {
          const teamPlant = getCleanTeamPlant(row["TeamPlant"] || "ไม่ระบุ");
          const status = row["StatusCall"] || "ไม่ระบุ";
          const pending = row["ค้างหน่วยงาน"] || "ไม่ระบุ";
          pivotData[teamPlant][status]++;
          pivotData[teamPlant][pending]++;
          ticketCounts[ticket] = true;
        }
      });
      const teamPlantTotals = teamPlants.map(teamPlant => {
        const total = Object.keys(pivotData[teamPlant]).reduce((sum, key) => {
          if (statusCalls.includes(key)) return sum + pivotData[teamPlant][key];
          return sum;
        }, 0);
        return { teamPlant, total, ...pivotData[teamPlant] };
      }).sort((a, b) => b.total - a.total);
      // ✅ ใส่คลาส summary-table เพื่อให้คอลัมน์ "รวม" จัดกึ่งกลาง
      let pivotTableHtml = `
        <table class='detail-table summary-table'>
          <thead>
            <tr>
              <th>ศูนย์พื้นที่</th>
              <th class='fixed-width'>รวม</th>
              ${statusCalls.map(status => `<th class='fixed-width'>${status}</th>`).join('')}
              ${orderedPendingUnits.map(pending => `<th class='fixed-width'>${pending}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${teamPlantTotals.map(({ teamPlant, total }) => `
              <tr>
                <td>${teamPlant}</td>
                <td class='fixed-width'>${total === 0 ? '-' : total}</td>
                ${statusCalls.map(status => `<td class='fixed-width'>${pivotData[teamPlant][status] === 0 ? '-' : pivotData[teamPlant][status]}</td>`).join('')}
                ${orderedPendingUnits.map(pending => `<td class='fixed-width'>${pivotData[teamPlant][pending] === 0 ? '-' : pivotData[teamPlant][pending]}</td>`).join('')}
              </tr>
            `).join('')}
            <tr>
              <td><strong>รวม</strong></td>
              <td class='fixed-width'><strong>${totalCalls === 0 ? '-' : totalCalls}</strong></td>
              ${statusCalls.map(status => {
                const totalStatus = teamPlants.reduce((sum, teamPlant) => sum + pivotData[teamPlant][status], 0);
                return `<td class='fixed-width'><strong>${totalStatus === 0 ? '-' : totalStatus}</strong></td>`;
              }).join('')}
              ${orderedPendingUnits.map(pending => {
                const totalPending = teamPlants.reduce((sum, teamPlant) => sum + pivotData[teamPlant][pending], 0);
                return `<td class='fixed-width'><strong>${totalPending === 0 ? '-' : totalPending}</strong></td>`;
              }).join('')}
            </tr>
          </tbody>
        </table>
      `;
      let summaryHtml = `
        <div><span class='label'>จำนวน Call ทั้งหมด:</span> <span class='value'>${totalCalls} Call</span></div>
        <h3>จำนวน Call ค้างตามศูนย์พื้นที่และสถานะ Call</h3>
        ${pivotTableHtml}
      `;
      summaryContent.innerHTML = summaryHtml;
      summaryModal.style.display = "block";
    }
    function showSpareSummary() {
      const baseFilteredData = getBaseFilteredData();
      let filteredData = baseFilteredData.filter(row => (row["StatusCall"] || "").trim() === "รอของเข้า");
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              // already filtered to pending
              break;
            case 'success':
              filteredData = [];
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = [];
              break;
          }
        }
      }
      if (filteredData.length === 0) {
        spareSummaryContent.innerHTML = '<p>ไม่มีข้อมูลสำหรับ StatusCall = "รอของเข้า"</p>';
        spareSummaryModal.style.display = "block";
        return;
      }
      const pivotData = {};
      const materials = [...new Set(filteredData.map(row => (row["Material"] + '|' + getDesc(row))))];
      const pendingUnits = [...new Set(filteredData.map(row => row["ค้างหน่วยงาน"] || "ไม่ระบุ"))]
        .map(unit => unit.replace(/Stock\s*/gi, '').trim())
        .filter(unit => unit)
        .sort();
      materials.forEach(matDesc => {
        pivotData[matDesc] = { total: 0 };
        pendingUnits.forEach(pending => { pivotData[matDesc][pending] = 0; });
      });
      filteredData.forEach(row => {
        const matDesc = row["Material"] + '|' + getDesc(row);
        const pending = (row["ค้างหน่วยงาน"] || "ไม่ระบุ").replace(/Stock\s*/gi, '').trim();
        if (pivotData[matDesc] && pending) { pivotData[matDesc].total++; pivotData[matDesc][pending]++; }
      });
      const sortedMaterials = materials.sort((a, b) => pivotData[b].total - pivotData[a].total);
      let pivotTableHtml = `
        <table class='detail-table'>
          <thead>
            <tr>
              <th>Material</th>
              <th>Description</th>
              <th class='fixed-width'>จำนวนรวม</th>
              ${pendingUnits.map(pending => `<th class='fixed-width'>${pending}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${sortedMaterials.map(matDesc => {
              const [material, description] = matDesc.split('|');
              const data = pivotData[matDesc];
              return `
                <tr>
                  <td title="${material}">${material}</td>
                  <td title="${description}">${description}</td>
                  <td class='fixed-width'>${data.total === 0 ? '-' : data.total}</td>
                  ${pendingUnits.map(pending => `<td class='fixed-width'>${data[pending] === 0 ? '-' : data[pending]}</td>`).join('')}
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      spareSummaryContent.innerHTML = pivotTableHtml;
      spareSummaryModal.style.display = "block";
    }
    function printSummaryContent() {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>พิมพ์สรุปข้อมูล</title>
            <style>
              body { font-family: 'Prompt', sans-serif; margin: 10mm; padding: 0; }
              h2, h3 { color: #000; margin: 10px 0; }
              .detail-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              .detail-table th, .detail-table td { padding: 8px; border: 1px solid #ccc; text-align: center; }
              .detail-table th { background-color: #007bff; color: white; }
              .detail-table tr:nth-child(even) { background-color: #f9f9f9; }
              .detail-table th:not(:first-child), .detail-table td:not(:first-child) { width: 80px; min-width: 80px; max-width: 80px; }
              .detail-table th:first-child, .detail-table td:first-child { width: auto; min-width: 120px; }
              .label { font-weight: bold; color: #007bff; }
              .value { color: #000; }
              /* ✅ กึ่งกลางคอลัมน์ "รวม" ในหน้าพิมพ์ด้วย */
              .summary-table th:nth-child(2), .summary-table td:nth-child(2){ text-align:center !important; }
              @media print { body { margin: 0; } @page { margin: 10mm; } }
            </style>
          </head>
          <body onload="window.print()">
            <h2>สรุปข้อมูล Call ค้าง</h2>
            ${summaryContent.innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
    }
    function printSpareSummaryContent() {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>พิมพ์สรุปอะไหล่</title>
            <style>
              body { font-family: 'Prompt', sans-serif; margin: 10mm; padding: 0; }
              h2, h3 { color: #000; margin: 10px 0; }
              .detail-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              .detail-table th, .detail-table td { padding: 8px; border: 1px solid #ccc; text-align: center; }
              .detail-table th { background-color: #007bff; color: white; }
              .detail-table tr:nth-child(even) { background-color: #f9f9f9; }
              .detail-table th:not(:first-child), .detail-table td:not(:first-child) { width: 80px; min-width: 80px; max-width: 80px; }
              .detail-table th:first-child, .detail-table td:first-child { width: auto; min-width: 120px; }
              @media print { body { margin: 0; } @page { margin: 10mm; } }
            </style>
          </head>
          <body onload="window.print()">
            <h2>สรุปอะไหล่ (รอของเข้า)</h2>
            ${spareSummaryContent.innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
    }
    // Dashboard click events
    totalCard.addEventListener('click', () => {
      dashboardFilter = null;
      updateActiveCard('totalCard');
      // ✅ เพิ่ม: Reset filters กลับไปค่าตั้งต้นเพื่อแสดง Call ทั้งหมด
      employeeFilter.value = "";
      pendingFilter.value = "";
      stockFilter.value = "";
      statusCallFilter.value = "";
      searchInput.value = "";
      filterAndRenderTable();
    });
    pendingCard.addEventListener('click', () => {
      dashboardFilter = 'pending';
      updateActiveCard('pendingCard');
      filterAndRenderTable();
    });
    successCard.addEventListener('click', () => {
      dashboardFilter = 'success';
      updateActiveCard('successCard');
      filterAndRenderTable();
    });
    waitingResponseCard.addEventListener('click', () => {
      dashboardFilter = 'waitingResponse';
      updateActiveCard('waitingResponseCard');
      filterAndRenderTable();
    });
    over7Card.addEventListener('click', () => {
      dashboardFilter = 'over7';
      updateActiveCard('over7Card');
      filterAndRenderTable();
    });
    requestCard.addEventListener('click', () => {
      dashboardFilter = 'request';
      updateActiveCard('requestCard');
      filterAndRenderTable();
    });
    nawaCard.addEventListener('click', () => {
      dashboardFilter = 'nawaVipa';
      updateActiveCard('nawaCard');
      filterAndRenderTable();
    });
    maxCard.addEventListener('click', () => {
      const base = getBaseFilteredData();
      if (base.length === 0) return;
      const metrics = calculateDashboardMetrics(base);
      const maxPU = metrics.maxPendingUnit;
      if (maxPU !== '-') {
        pendingFilter.value = maxPU;
        dashboardFilter = null;
        updateActiveCard('maxCard');
        filterAndRenderTable();
      }
    });
    graphCard.addEventListener('click', showGraph);
    spareSummaryCard.addEventListener('click', showSpareSummary);
    // ปิดโมดัล
    closeModal.onclick = () => { modal.style.display = "none"; currentTicketNumber = null; currentRowData = null; };
    closeGraphModal.onclick = () => graphModal.style.display = "none";
    closeSummaryModal.onclick = () => summaryModal.style.display = "none";
    closeSpareSummaryModal.onclick = () => spareSummaryModal.style.display = "none";
    window.onclick = e => {
      if (e.target == modal) { modal.style.display = "none"; currentTicketNumber = null; currentRowData = null; }
      if (e.target == graphModal) graphModal.style.display = "none";
      if (e.target == summaryModal) summaryModal.style.display = "none";
      if (e.target == spareSummaryModal) spareSummaryModal.style.display = "none";
    };
    // ปุ่มต่าง ๆ
    excelButton.addEventListener("click", exportToCSV);
    summaryButton.addEventListener("click", showSummary);
    itemsPerPageSelect.addEventListener("change", e => { itemsPerPage = parseInt(e.target.value); currentPage = 1; filterAndRenderTable(); });
    searchInput.addEventListener("keypress", e => { if (e.key === "Enter") filterAndRenderTable(); });
    searchButton.addEventListener("click", filterAndRenderTable);
    printTableButton.addEventListener("click", printTable);
    function populateTeamPlantFilter(data) {
      if (!data || data.length === 0) return;
      const teamPlants = [...new Set(data.map(row => getCleanTeamPlant(row["TeamPlant"])).filter(Boolean))].sort();
      employeeFilter.innerHTML = '<option value="">ทั้งหมด</option>';
      teamPlants.forEach(teamPlant => {
        const option = document.createElement("option");
        option.value = teamPlant;
        option.textContent = teamPlant;
        employeeFilter.appendChild(option);
      });
    }
    function updatePendingFilter(data, selectedTeamPlant) {
      if (!data || data.length === 0) return;
      const currentPendingValue = pendingFilter.value;
      const filteredData = selectedTeamPlant ? data.filter(row => getCleanTeamPlant(row["TeamPlant"] || "") === selectedTeamPlant) : data;
      const pendingUnits = [...new Set(filteredData.map(row => row["ค้างหน่วยงาน"]).filter(Boolean))].sort();
      pendingFilter.innerHTML = '<option value="">ทั้งหมด</option>';
      pendingUnits.forEach(pending => {
        const option = document.createElement("option");
        option.value = pending;
        option.textContent = pending;
        pendingFilter.appendChild(option);
      });
      if (currentPendingValue && pendingUnits.includes(currentPendingValue)) pendingFilter.value = currentPendingValue;
      else pendingFilter.value = "";
      updateStockFilter(data, selectedTeamPlant, pendingFilter.value);
      updateStatusCallFilter(data, selectedTeamPlant, pendingFilter.value);
    }
    function updateStockFilter(data, selectedTeamPlant, selectedPending) {
      if (!data || data.length === 0) return;
      const currentStockValue = stockFilter.value;
      let filteredData = data;
      if (selectedTeamPlant) filteredData = filteredData.filter(row => getCleanTeamPlant(row["TeamPlant"] || "") === selectedTeamPlant);
      if (selectedPending) filteredData = filteredData.filter(row => (row["ค้างหน่วยงาน"] || "") === selectedPending);
      const stockResponses = [...new Set(filteredData.map(row => row["คลังตอบ"]).filter(Boolean))].sort();
      stockFilter.innerHTML = '<option value="">ทั้งหมด</option>';
      stockResponses.forEach(stock => {
        const option = document.createElement("option");
        option.value = stock;
        option.textContent = stock;
        stockFilter.appendChild(option);
      });
      if (currentStockValue && stockResponses.includes(currentStockValue)) stockFilter.value = currentStockValue;
      else stockFilter.value = "";
    }
    function updateStatusCallFilter(data, selectedTeamPlant, selectedPending) {
      if (!data || data.length === 0) return;
      const currentStatusCallValue = statusCallFilter.value;
      let filteredData = data;
      if (selectedTeamPlant) filteredData = filteredData.filter(row => getCleanTeamPlant(row["TeamPlant"] || "") === selectedTeamPlant);
      if (selectedPending) filteredData = filteredData.filter(row => (row["ค้างหน่วยงาน"] || "") === selectedPending);
      const statusCalls = [...new Set(filteredData.map(row => row["StatusCall"]).filter(Boolean))].sort();
      statusCallFilter.innerHTML = '<option value="">ทั้งหมด</option>';
      statusCalls.forEach(status => {
        const option = document.createElement("option");
        option.value = status;
        option.textContent = status;
        statusCallFilter.appendChild(option);
      });
      if (currentStatusCallValue && statusCalls.includes(currentStatusCallValue)) statusCallFilter.value = currentStatusCallValue;
      else statusCallFilter.value = "";
    }
    function addSortListeners() {
      const sortableHeaders = document.querySelectorAll("th.sortable");
      sortableHeaders.forEach(header => {
        header.addEventListener("click", () => {
          const column = header.getAttribute("data-column");
          if (sortConfig.column === column) sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
          else { sortConfig.column = column; sortConfig.direction = 'asc'; }
          updateSortArrows();
          filterAndRenderTable();
        });
      });
    }
    function updateSortArrows() {
      const sortableHeaders = document.querySelectorAll("th.sortable");
      sortableHeaders.forEach(header => {
        const arrow = header.querySelector(".arrow");
        const column = header.getAttribute("data-column");
        arrow.textContent = (column === sortConfig.column) ? (sortConfig.direction === 'asc' ? '↑' : '↓') : '';
      });
    }
    function filterAndRenderTable() {
      const baseFilteredData = getBaseFilteredData();
      let filteredData = [...baseFilteredData];
      if (dashboardFilter) {
        if (dashboardFilter.startsWith('calltype_')) {
          const type = dashboardFilter.split('_')[1];
          filteredData = filteredData.filter(row => (row["Call Type"] || "") === type);
        } else {
          switch(dashboardFilter) {
            case 'pending':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "รอของเข้า");
              break;
            case 'success':
              filteredData = filteredData.filter(row => (row["StatusCall"] || "") === "สำเร็จ");
              break;
            case 'waitingResponse':
              filteredData = filteredData.filter(row => (row["คลังตอบ"] || "") === "รอตรวจสอบ");
              break;
            case 'over7':
              filteredData = filteredData.filter(row => {
                const day = parseFloat(row["DayRepair"] || 0);
                return day > 7;
              });
              break;
            case 'request':
              filteredData = filteredData.filter(row => {
                const mat = row["Material"] || "";
                return mat === "" || mat === "-" || !mat.trim();
              });
              break;
            case 'nawaVipa':
              filteredData = filteredData.filter(row => {
                const status = row["StatusCall"] || "";
                return status === "เบิกนวนคร" || status === "เบิกวิภาวดี";
              });
              break;
          }
        }
      }
      const selectedTeamPlant = employeeFilter.value;
      updatePendingFilter(allData, selectedTeamPlant);
      updateStockFilter(allData, selectedTeamPlant, pendingFilter.value);
      updateStatusCallFilter(allData, selectedTeamPlant, pendingFilter.value);
      // Update Dashboard Metrics
      const metrics = calculateDashboardMetrics(filteredData);
      document.getElementById("totalCalls").textContent = metrics.totalCalls;
      document.getElementById("callsPending").textContent = metrics.callsPending;
      document.getElementById("callsSuccess").textContent = metrics.callsSuccess;
      document.getElementById("callsNawaVipa").textContent = metrics.callsNawaVipa;
      document.getElementById("callsWaitingResponse").textContent = metrics.callsWaitingResponse;
      document.getElementById("callsOver7").textContent = metrics.callsOver7;
      document.getElementById("callsRequest").textContent = metrics.callsRequest;
      document.getElementById("maxPendingUnit").textContent = metrics.maxPendingUnit;
      // Update Progress Bars and Percent Texts
      const total = metrics.totalCalls || 0;
      const calculatePercent = (value) => total > 0 ? ((value / total) * 100).toFixed(0) : 0;
      document.getElementById("totalProgress").style.width = "100%";
      document.getElementById("totalPercent").textContent = "100%";
      document.getElementById("pendingProgress").style.width = `${calculatePercent(metrics.callsPending)}%`;
      document.getElementById("pendingPercent").textContent = `${calculatePercent(metrics.callsPending)}%`;
      document.getElementById("successProgress").style.width = `${calculatePercent(metrics.callsSuccess)}%`;
      document.getElementById("successPercent").textContent = `${calculatePercent(metrics.callsSuccess)}%`;
      document.getElementById("nawaProgress").style.width = `${calculatePercent(metrics.callsNawaVipa)}%`;
      document.getElementById("nawaPercent").textContent = `${calculatePercent(metrics.callsNawaVipa)}%`;
      document.getElementById("requestProgress").style.width = `${calculatePercent(metrics.callsRequest)}%`;
      document.getElementById("requestPercent").textContent = `${calculatePercent(metrics.callsRequest)}%`;
      document.getElementById("over7Progress").style.width = `${calculatePercent(metrics.callsOver7)}%`;
      document.getElementById("over7Percent").textContent = `${calculatePercent(metrics.callsOver7)}%`;
      document.getElementById("waitingResponseProgress").style.width = `${calculatePercent(metrics.callsWaitingResponse)}%`;
      document.getElementById("waitingResponsePercent").textContent = `${calculatePercent(metrics.callsWaitingResponse)}%`;
      // Update Call Type Dashboard (ใช้ baseFilteredData เพื่อแสดงการ์ดทั้งหมด ไม่หายเมื่อกรอง)
      updateCallTypeDashboard(baseFilteredData);
      const uniqueTickets = [...new Set(filteredData.map(row => row["Ticket Number"]).filter(Boolean))].length;
      document.getElementById("ticketCountValue").textContent = uniqueTickets;
      if (sortConfig.column) {
        filteredData.sort((a, b) => {
          let valueA = a[sortConfig.column] ?? (sortConfig.column === "Description" ? getDesc(a) : "");
          let valueB = b[sortConfig.column] ?? (sortConfig.column === "Description" ? getDesc(b) : "");
          if (sortConfig.column === 'DayRepair') {
            let dayA = parseFloat(valueA) || 0, dayB = parseFloat(valueB) || 0;
            let ticketA = a["Ticket Number"] || "", ticketB = b["Ticket Number"] || "";
            if (dayA !== dayB) return sortConfig.direction === 'asc' ? dayA - dayB : dayB - dayA;
            return ticketA.localeCompare(ticketB);
          } else {
            valueA = valueA.toString().toLowerCase(); valueB = valueB.toString().toLowerCase();
            return sortConfig.direction === 'asc'
              ? (valueA > valueB ? 1 : valueA < valueB ? -1 : 0)
              : (valueA < valueB ? 1 : valueA > valueB ? -1 : 0);
          }
        });
      } else {
        filteredData.sort((a, b) => {
          let dayA = parseFloat(a["DayRepair"]) || 0;
          let dayB = parseFloat(b["DayRepair"]) || 0;
          let ticketA = a["Ticket Number"] || "";
          let ticketB = b["Ticket Number"] || "";
          if (dayA !== dayB) return dayB - dayA;
          return ticketA.localeCompare(ticketB);
        });
      }
      renderTable(filteredData);
      updateCallCount(filteredData);
    }
    employeeFilter.addEventListener("change", filterAndRenderTable);
    pendingFilter.addEventListener("change", filterAndRenderTable);
    stockFilter.addEventListener("change", filterAndRenderTable);
    statusCallFilter.addEventListener("change", filterAndRenderTable);
    function updateCallCount(data) {
      const count = [...new Set(data.map(row => row["Ticket Number"]).filter(Boolean))].length;
      document.getElementById("callCountValue").textContent = count;
    }
    function renderTable(data) {
      tableBody.innerHTML = '';
      if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="20">ไม่มีข้อมูลที่ตรงกับเงื่อนไข</td></tr>';
        return;
      }
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const paginatedData = data.slice(startIdx, endIdx);
      const ticketGroups = {};
      data.forEach(row => {
        const ticket = row["Ticket Number"];
        if (!ticketGroups[ticket]) ticketGroups[ticket] = [];
        ticketGroups[ticket].push(row);
      });
      const uniqueTickets = Object.keys(ticketGroups).sort();
      const colorMap = {};
      uniqueTickets.forEach((ticket, index) => { colorMap[ticket] = index % 2 === 0 ? "yellow-light" : "pink-pastel"; });
      paginatedData.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.style.animationDelay = `${i * 0.05}s`;
        const ticket = row["Ticket Number"];
        tr.className = colorMap[ticket] || "yellow-light";
        const columns = ["DayRepair","DateTime","Ticket Number","Brand","Call Type","Team","TeamPlant","ค้างหน่วยงาน","Material","Description","Nawa","Vipa","Request","QtyPlant","คลังตอบ","StatusCall","วันที่ตอบ","UserAns","Answer1"];
        columns.forEach(col => {
          const td = document.createElement("td");
          let cellValue = (col === "Description") ? getDesc(row) : (row[col] || "-");
          if (col === "TeamPlant") {
            cellValue = getCleanTeamPlant(cellValue);
          }
          let displayValue = cellValue;
          if (col === "DateTime") {
            displayValue = extractDate(cellValue);
          }
          if (col === "DayRepair") {
            displayValue = isNaN(parseFloat(displayValue)) ? "-" : parseFloat(displayValue).toFixed(0);
          } else if (col === "คลังตอบ") {
            if (cellValue === "ดำเนินการแล้ว") { displayValue = "ดำเนินการแล้ว"; td.style.color = "var(--success-color)"; td.style.fontWeight = "bold"; }
            else if (cellValue === "รอตรวจสอบ") { displayValue = "รอตรวจสอบ"; td.style.color = "var(--danger-color)"; td.style.fontWeight = "bold"; }
          } else if (col === "StatusCall") {
            if (cellValue === "รอของเข้า") { td.style.color = "var(--danger-color)"; td.style.fontWeight = "bold"; }
            else if (cellValue === "สำเร็จ") { td.style.color = "var(--success-color)"; td.style.fontWeight = "bold"; }
            else if (cellValue === "เบิกนวนคร") { td.style.color = "var(--info-color)"; td.style.fontWeight = "bold"; }
            else if (cellValue === "เบิกวิภาวดี") { td.style.color = "var(--warning-color)"; td.style.fontWeight = "bold"; }
            else { td.style.color = "var(--text-secondary)"; }
          }
          td.textContent = displayValue;
          td.classList.add("text-left");
          tr.appendChild(td);
        });
        const detailTd = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "ดูรายละเอียด";
        btn.className = "detail-button";
        btn.onclick = () => {
          currentTicketNumber = row["Ticket Number"];
          currentRowData = row; // เก็บแถวปัจจุบันสำหรับพิมพ์จากโมดัล
          const timeline = row["TimeLine"] || "";
          let timelineHtml = '<table class="timeline-table"><thead><tr><th>วันที่</th><th>ผู้แจ้ง</th><th>สถานะ</th><th>รายละเอียด</th></tr></thead><tbody>';
          if (timeline) {
            const events = timeline.split('|');
            events.forEach(event => {
              let eventTrim = event.trim();
              if (eventTrim) {
                let date = ''; let person = ''; let status = ''; let details = '';
                const dateMatch = eventTrim.match(/^(\d{2}\.\d{2})\s/);
                if (dateMatch) { date = dateMatch[1]; eventTrim = eventTrim.slice(dateMatch[0].length); }
                if (eventTrim.startsWith('Backlog ')) { person = 'Backlog'; eventTrim = eventTrim.slice(8); }
                else if (eventTrim.startsWith('คุณ')) {
                  const personEnd = eventTrim.indexOf(' ', 3);
                  if (personEnd > -1) { person = eventTrim.slice(0, personEnd); eventTrim = eventTrim.slice(personEnd + 1); }
                  else { person = eventTrim; eventTrim = ''; }
                }
                if (eventTrim.startsWith('แจ้งค้าง_')) {
                  const statusEnd = eventTrim.indexOf(' ', 9);
                  if (statusEnd > -1) { status = eventTrim.slice(0, statusEnd); details = eventTrim.slice(statusEnd + 1); }
                  else { status = eventTrim; details = ''; }
                } else { status = eventTrim; details = ''; }
                timelineHtml += `<tr><td>${date || '-'}</td><td>${person || '-'}</td><td>${status || '-'}</td><td>${details || '-'}</td></tr>`;
              }
            });
          }
          timelineHtml += '</tbody></table>';
          modalContent.innerHTML = `
            <div><span class="label">ผ่านมา:</span> <span class="value">${row["DayRepair"] || "-"}</span></div>
            <div><span class="label">วันที่แจ้ง:</span> <span class="value">${extractDate(row["DateTime"] || "-")}</span></div>
            <div><span class="label">Ticket Number:</span> <span class="value">${row["Ticket Number"] || "-"}</span></div>
            <div><span class="label">Brand:</span> <span class="value">${row["Brand"] || "-"}</span></div>
            <div><span class="label">Call Type:</span> <span class="value">${row["Call Type"] || "-"}</span></div>
            <div><span class="label">Team:</span> <span class="value">${row["Team"] || "-"}</span></div>
            <div><span class="label">ศูนย์พื้นที่:</span> <span class="value">${getCleanTeamPlant(row["TeamPlant"]) || "-"}</span></div>
            <div><span class="label">ค้างหน่วยงาน:</span> <span class="value">${row["ค้างหน่วยงาน"] || "-"}</span></div>
            <div><span class="label">Material:</span> <span class="value">${row["Material"] || "-"}</span></div>
            <div><span class="label">Description:</span> <span class="value">${getDesc(row) || "-"}</span></div>
            <div><span class="label">Nawa:</span> <span class="value">${row["Nawa"] || "-"}</span></div>
            <div><span class="label">Vipa:</span> <span class="value">${row["Vipa"] || "-"}</span></div>
            <div><span class="label">Request:</span> <span class="value">${row["Request"] || "-"}</span></div>
            <div><span class="label">ศูนย์พื้นที่:</span> <span class="value">${row["QtyPlant"] || "-"}</span></div>
            <div><span class="label">คลังตอบ:</span> <span class="value">${row["คลังตอบ"] || "-"}</span></div>
            <div><span class="label">สถานะ Call:</span> <span class="value">${row["StatusCall"] || "-"}</span></div>
            <div><span class="label">วันที่ตอบ:</span> <span class="value">${row["วันที่ตอบ"] || "-"}</span></div>
            <div><span class="label">ผู้แจ้ง:</span> <span class="value">${row["UserAns"] || "-"}</span></div>
            <div><span class="label">แจ้งผล:</span> <span class="value">${row["Answer1"] || "-"}</span></div>
            <h3>ประวัติ Timeline</h3>
            ${timelineHtml}
          `;
          modal.style.display = "block";
        };
        detailTd.appendChild(btn);
        tr.appendChild(detailTd);
        tableBody.appendChild(tr);
      });
      updatePagination(data.length);
    }
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      currentPage = Math.min(currentPage, totalPages);
      if (currentPage < 1) currentPage = 1;
      pageNumbersContainer.innerHTML = '';
      const maxPageButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
      if (endPage - startPage + 1 < maxPageButtons) startPage = Math.max(1, endPage - maxPageButtons + 1);
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-number";
        if (i === currentPage) btn.classList.add("active");
        btn.addEventListener("click", () => { currentPage = i; filterAndRenderTable(); });
        pageNumbersContainer.appendChild(btn);
      }
      firstPageButton.disabled = currentPage === 1;
      prevPageButton.disabled = currentPage === 1;
      nextPageButton.disabled = currentPage === totalPages;
      lastPageButton.disabled = currentPage === totalPages;
      firstPageButton.onclick = () => { currentPage = 1; filterAndRenderTable(); };
      prevPageButton.onclick = () => { if (currentPage > 1) { currentPage--; filterAndRenderTable(); } };
      nextPageButton.onclick = () => { if (currentPage < totalPages) { currentPage++; filterAndRenderTable(); } };
      lastPageButton.onclick = () => { currentPage = totalPages; filterAndRenderTable(); };
    }
    // Initialize App (load data after login)
    function initApp() {
      showLoading();
      fetch(url)
        .then(r => r.json())
        .then(data => {
          allData = data;
          populateTeamPlantFilter(data);
          updatePendingFilter(data, employeeFilter.value);
          updateStockFilter(data, employeeFilter.value, pendingFilter.value);
          updateStatusCallFilter(data, employeeFilter.value, pendingFilter.value);
          filterAndRenderTable();
          addSortListeners();
          hideLoading();
        })
        .catch(err => {
          console.error('Error fetching data:', err);
          hideLoading();
          alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
        });
      fetchUpdateDate();
      initTheme();
    }
    // Initial check on page load
    checkLoginStatus();
   function canUserOrder() {
  const userUnit = localStorage.getItem('userUnit') || '';
  const allowedUnits = [
    'แผนกคลัง Spare part วิภาวดี 62',
    'แผนกคลังวัตถุดิบ'
  ];
  return allowedUnits.includes(userUnit.trim());
}
  </script>
</body>
</html>
